<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>مدير المتجر - نظام كاشير</title>
    
    <!-- خطوط Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- أيقونات Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        * {
            box-sizing: border-box;
            font-family: 'Tajawal', sans-serif;
            margin: 0;
            padding: 0;
        }

        body {
            margin: 0;
            background: linear-gradient(135deg, #0f2027, #203a43, #2c5364);
            color: #fff;
            min-height: 100vh;
            direction: rtl;
        }

        header {
            padding: 18px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(0, 0, 0, 0.25);
            backdrop-filter: blur(10px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .logo i {
            font-size: 26px;
            color: #00c6ff;
        }

        header h1 {
            font-size: 24px;
            font-weight: 700;
            background: linear-gradient(90deg, #00c6ff, #0072ff);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }

        nav {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        nav button {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: #fff;
            padding: 10px 18px;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            font-size: 15px;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            min-width: 120px;
            justify-content: center;
        }

        nav button:hover {
            background: rgba(0, 198, 255, 0.2);
            transform: translateY(-2px);
        }

        nav button.active {
            background: linear-gradient(90deg, #00c6ff, #0072ff);
            color: #000;
            box-shadow: 0 4px 12px rgba(0, 198, 255, 0.3);
        }

        .container {
            padding: 20px;
            max-width: 1600px;
            margin: 0 auto;
        }

        .card {
            background: rgba(255, 255, 255, 0.08);
            backdrop-filter: blur(15px);
            border-radius: 18px;
            padding: 24px;
            margin-bottom: 25px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
            transition: transform 0.3s ease;
        }

        .card:hover {
            transform: translateY(-5px);
        }

        .card h3 {
            font-size: 20px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
            color: #00c6ff;
        }

        .input-group {
            margin-bottom: 16px;
        }

        .input-group label {
            display: block;
            margin-bottom: 6px;
            font-weight: 600;
            color: #ddd;
        }

        input, select, textarea {
            width: 100%;
            padding: 14px 16px;
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
            font-size: 15px;
            transition: all 0.3s ease;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #00c6ff;
            box-shadow: 0 0 0 2px rgba(0, 198, 255, 0.2);
        }

        input::placeholder {
            color: rgba(255, 255, 255, 0.5);
        }

        .file-input-container {
            position: relative;
            overflow: hidden;
            margin-top: 10px;
        }

        .file-input-container input[type="file"] {
            position: absolute;
            top: 0;
            right: 0;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }

        .file-input-label {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            padding: 14px;
            background: rgba(0, 198, 255, 0.1);
            border: 2px dashed rgba(0, 198, 255, 0.5);
            border-radius: 10px;
            cursor: pointer;
            color: #00c6ff;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .file-input-label:hover {
            background: rgba(0, 198, 255, 0.2);
        }

        button.main {
            background: linear-gradient(90deg, #00c6ff, #0072ff);
            color: #000;
            font-weight: bold;
            cursor: pointer;
            padding: 16px;
            border-radius: 10px;
            border: none;
            font-size: 16px;
            margin-top: 10px;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        button.main:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 15px rgba(0, 198, 255, 0.4);
        }

        button.main:active {
            transform: translateY(0);
        }

        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .button-group button {
            flex: 1;
            padding: 12px;
            border-radius: 10px;
            border: none;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all 0.3s ease;
        }

        .btn-edit {
            background: rgba(255, 193, 7, 0.2);
            color: #ffc107;
        }

        .btn-edit:hover {
            background: rgba(255, 193, 7, 0.3);
        }

        .btn-delete {
            background: rgba(220, 53, 69, 0.2);
            color: #dc3545;
        }

        .btn-delete:hover {
            background: rgba(220, 53, 69, 0.3);
        }

        .btn-update {
            background: linear-gradient(90deg, #4cd964, #2ecc71);
            color: #000;
        }

        .btn-update:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 15px rgba(76, 217, 100, 0.4);
        }

        .btn-cancel {
            background: rgba(108, 117, 125, 0.2);
            color: #6c757d;
        }

        .btn-cancel:hover {
            background: rgba(108, 117, 125, 0.3);
        }

        .products {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .product {
            background: rgba(255, 255, 255, 0.08);
            border-radius: 16px;
            overflow: hidden;
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s ease;
        }

        .product:hover {
            transform: translateY(-8px);
            box-shadow: 0 12px 25px rgba(0, 0, 0, 0.3);
        }

        .product-img {
            width: 100%;
            height: 200px;
            object-fit: cover;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .product-info {
            padding: 18px;
        }

        .product-name {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 8px;
            color: #fff;
        }

        .product-category {
            display: inline-block;
            background: rgba(0, 198, 255, 0.15);
            color: #00c6ff;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 13px;
            margin-bottom: 12px;
        }

        .product-details {
            display: flex;
            justify-content: space-between;
            margin-top: 15px;
            font-size: 15px;
        }

        .product-price {
            color: #4cd964;
            font-weight: 700;
        }

        .product-quantity {
            color: #ffcc00;
            font-weight: 700;
        }

        .orders-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
            max-height: 600px;
            overflow-y: auto;
            padding-right: 10px;
        }

        .orders-list::-webkit-scrollbar {
            width: 8px;
        }

        .orders-list::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
        }

        .orders-list::-webkit-scrollbar-thumb {
            background: rgba(0, 198, 255, 0.3);
            border-radius: 10px;
        }

        .orders-list::-webkit-scrollbar-thumb:hover {
            background: rgba(0, 198, 255, 0.5);
        }

        .order-item {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 18px;
            border-left: 4px solid #00c6ff;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .order-info h4 {
            font-size: 17px;
            margin-bottom: 5px;
        }

        .order-details {
            display: flex;
            gap: 20px;
            color: #ccc;
            font-size: 14px;
        }

        .order-status {
            padding: 6px 15px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 13px;
        }

        .status-pending {
            background: rgba(255, 204, 0, 0.2);
            color: #ffcc00;
        }

        .status-processing {
            background: rgba(52, 152, 219, 0.2);
            color: #3498db;
        }

        .status-shipped {
            background: rgba(155, 89, 182, 0.2);
            color: #9b59b6;
        }

        .status-delivered {
            background: rgba(76, 217, 100, 0.2);
            color: #4cd964;
        }

        .status-completed {
            background: rgba(46, 204, 113, 0.2);
            color: #2ecc71;
        }

        .status-cancelled {
            background: rgba(255, 59, 48, 0.2);
            color: #ff3b30;
        }

        .page-title {
            font-size: 28px;
            margin-bottom: 25px;
            display: flex;
            align-items: center;
            gap: 12px;
            color: #fff;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #aaa;
        }

        .empty-state i {
            font-size: 60px;
            margin-bottom: 20px;
            opacity: 0.5;
        }

        .empty-state h3 {
            font-size: 22px;
            margin-bottom: 10px;
            color: #ccc;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.08);
            border-radius: 16px;
            padding: 22px;
            text-align: center;
            border-top: 4px solid;
        }

        .stat-card.products-stat {
            border-color: #00c6ff;
        }

        .stat-card.orders-stat {
            border-color: #4cd964;
        }

        .stat-card.sales-stat {
            border-color: #ffcc00;
        }

        .stat-value {
            font-size: 36px;
            font-weight: 700;
            margin: 10px 0;
        }

        .stat-label {
            color: #aaa;
            font-size: 15px;
        }

        .notification {
            position: fixed;
            top: 20px;
            left: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.9);
            border-radius: 10px;
            padding: 16px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            z-index: 1000;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            border-right: 5px solid #00c6ff;
            transform: translateY(-100px);
            opacity: 0;
            transition: all 0.5s ease;
        }

        .notification.show {
            transform: translateY(0);
            opacity: 1;
        }

        .notification-content {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .notification i {
            font-size: 24px;
            color: #00c6ff;
        }

        .close-notification {
            background: none;
            border: none;
            color: #fff;
            font-size: 20px;
            cursor: pointer;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: #00c6ff;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .action-buttons {
            display: flex;
            gap: 8px;
            margin-top: 15px;
        }

        .action-buttons button {
            flex: 1;
            padding: 8px 12px;
            border-radius: 8px;
            border: none;
            font-size: 14px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            transition: all 0.3s ease;
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1001;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .modal {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 30px;
            width: 90%;
            max-width: 600px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            transform: translateY(-50px);
            opacity: 0;
            transition: all 0.3s ease;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal::-webkit-scrollbar {
            width: 8px;
        }

        .modal::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
        }

        .modal::-webkit-scrollbar-thumb {
            background: rgba(0, 198, 255, 0.3);
            border-radius: 10px;
        }

        .modal::-webkit-scrollbar-thumb:hover {
            background: rgba(0, 198, 255, 0.5);
        }

        .modal-overlay.active .modal {
            transform: translateY(0);
            opacity: 1;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
        }

        .modal-title {
            font-size: 22px;
            color: #00c6ff;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .close-modal {
            background: none;
            border: none;
            color: #fff;
            font-size: 24px;
            cursor: pointer;
        }

        .bulk-actions {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .bulk-actions button {
            padding: 10px 16px;
            border-radius: 10px;
            border: none;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s ease;
        }

        .bulk-delete {
            background: rgba(220, 53, 69, 0.2);
            color: #dc3545;
        }

        .bulk-delete:hover {
            background: rgba(220, 53, 69, 0.3);
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 10px;
        }

        .checkbox-group input[type="checkbox"] {
            width: 18px;
            height: 18px;
        }

        .categories-list {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
        }

        .category-tag {
            background: rgba(0, 198, 255, 0.15);
            color: #00c6ff;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .category-tag:hover {
            background: rgba(0, 198, 255, 0.25);
            transform: translateY(-2px);
        }

        .order-details-modal {
            max-width: 700px;
        }

        .order-items-list {
            margin: 15px 0;
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            overflow: hidden;
        }

        .order-item-row {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr 1fr;
            padding: 10px 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .order-item-row:last-child {
            border-bottom: none;
        }

        .order-item-row.header {
            background: rgba(255, 255, 255, 0.05);
            font-weight: bold;
        }

        .customer-info {
            background: rgba(255, 255, 255, 0.05);
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
        }

        .payment-info {
            background: rgba(255, 255, 255, 0.05);
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
        }

        .summary-info {
            background: rgba(255, 255, 255, 0.05);
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
        }

        .info-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            padding-bottom: 8px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .info-row:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }

        .info-label {
            color: #aaa;
        }

        .info-value {
            font-weight: bold;
            color: #fff;
        }

        .btn-status {
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 12px;
            font-weight: bold;
            margin-left: 5px;
        }

        .btn-status-completed {
            background: rgba(76, 217, 100, 0.2);
            color: #4cd964;
        }

        .btn-status-pending {
            background: rgba(255, 204, 0, 0.2);
            color: #ffcc00;
        }

        .btn-status-cancelled {
            background: rgba(255, 59, 48, 0.2);
            color: #ff3b30;
        }

        /* تعديلات جديدة للصور */
        .image-preview {
            margin-top: 15px;
            text-align: center;
        }
        
        .image-preview img {
            max-width: 200px;
            max-height: 150px;
            border-radius: 10px;
            border: 2px solid rgba(0, 198, 255, 0.3);
        }
        
        .payment-proof-image {
            max-width: 300px;
            max-height: 200px;
            border-radius: 10px;
            margin: 10px 0;
            cursor: pointer;
            transition: transform 0.3s ease;
        }
        
        .payment-proof-image:hover {
            transform: scale(1.05);
        }
        
        .imgbb-info {
            background: rgba(0, 198, 255, 0.1);
            border-radius: 10px;
            padding: 10px;
            margin-top: 10px;
            font-size: 12px;
            color: #00c6ff;
        }

        /* WhatsApp Button Styles */
        .whatsapp-btn {
            background: linear-gradient(90deg, #25D366, #128C7E);
            color: white;
            border: none;
            padding: 10px 16px;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all 0.3s ease;
            margin-top: 10px;
            width: 100%;
        }

        .whatsapp-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(37, 211, 102, 0.3);
        }

        .whatsapp-btn.small {
            padding: 6px 12px;
            font-size: 13px;
            width: auto;
            margin-top: 0;
        }

        .whatsapp-info {
            background: rgba(37, 211, 102, 0.1);
            border-radius: 10px;
            padding: 15px;
            margin: 15px 0;
            border: 1px solid rgba(37, 211, 102, 0.3);
        }

        .whatsapp-info h4 {
            color: #25D366;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* WhatsApp Modal Styles */
        .whatsapp-modal {
            max-width: 500px;
        }

        .whatsapp-preview {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            padding: 20px;
            margin: 15px 0;
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid rgba(37, 211, 102, 0.3);
        }

        .whatsapp-preview h5 {
            color: #25D366;
            margin-bottom: 10px;
        }

        .whatsapp-preview pre {
            color: #fff;
            font-family: inherit;
            white-space: pre-wrap;
            word-wrap: break-word;
            font-size: 14px;
            line-height: 1.5;
        }

        /* أنماط نظام الكاشير الجديدة */
        .cashier-container {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 20px;
            margin-top: 20px;
        }

        @media (max-width: 1200px) {
            .cashier-container {
                grid-template-columns: 1fr;
            }
        }

        .product-search-container {
            position: relative;
            margin-bottom: 20px;
        }

        .product-search-container input {
            padding-left: 50px;
            font-size: 16px;
        }

        .product-search-container i {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: #00c6ff;
            font-size: 18px;
        }

        .cart-items {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 10px;
            margin-bottom: 20px;
        }

        .cart-items::-webkit-scrollbar {
            width: 8px;
        }

        .cart-items::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
        }

        .cart-items::-webkit-scrollbar-thumb {
            background: rgba(0, 198, 255, 0.3);
            border-radius: 10px;
        }

        .cart-items::-webkit-scrollbar-thumb:hover {
            background: rgba(0, 198, 255, 0.5);
        }

        .cart-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            margin-bottom: 10px;
        }

        .cart-item:last-child {
            margin-bottom: 0;
        }

        .cart-item-info {
            flex: 1;
        }

        .cart-item-name {
            font-weight: 600;
            margin-bottom: 5px;
        }

        .cart-item-details {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 5px;
        }

        .cart-item-price {
            color: #4cd964;
            font-size: 14px;
        }

        .cart-item-total {
            color: #4cd964;
            font-weight: bold;
            margin-top: 5px;
        }

        .cart-item-controls {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .quantity-control {
            display: flex;
            align-items: center;
            gap: 5px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 5px;
            padding: 5px;
        }

        .quantity-btn {
            background: rgba(0, 198, 255, 0.2);
            border: none;
            color: #00c6ff;
            width: 30px;
            height: 30px;
            border-radius: 5px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .quantity-btn:hover {
            background: rgba(0, 198, 255, 0.3);
        }

        .quantity-input {
            width: 60px;
            text-align: center;
            background: transparent;
            border: none;
            color: white;
            font-weight: bold;
        }

        .quantity-input-small {
            width: 40px;
            text-align: center;
            background: transparent;
            border: none;
            color: white;
            font-weight: bold;
        }

        .remove-item {
            background: rgba(220, 53, 69, 0.2);
            border: none;
            color: #dc3545;
            width: 30px;
            height: 30px;
            border-radius: 5px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .remove-item:hover {
            background: rgba(220, 53, 69, 0.3);
        }

        .cart-summary {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
        }

        .summary-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .summary-row.total {
            border-bottom: none;
            font-size: 20px;
            font-weight: bold;
            color: #4cd964;
            margin-top: 10px;
            padding-top: 15px;
            border-top: 2px solid rgba(255, 255, 255, 0.1);
        }

        .payment-methods {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin: 20px 0;
        }

        .payment-method {
            padding: 15px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }

        .payment-method:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .payment-method.active {
            border-color: #00c6ff;
            background: rgba(0, 198, 255, 0.1);
        }

        .payment-method i {
            font-size: 24px;
            margin-bottom: 10px;
            color: #00c6ff;
        }

        .customer-info-input {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
        }

        .quick-actions {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 10px;
            margin: 20px 0;
        }

        .quick-action-btn {
            padding: 12px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            border: none;
            color: white;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
            transition: all 0.3s ease;
        }

        .quick-action-btn:hover {
            background: rgba(0, 198, 255, 0.2);
            transform: translateY(-2px);
        }

        .quick-action-btn i {
            font-size: 20px;
            color: #00c6ff;
        }

        .receipt-container {
            background: white;
            color: black;
            padding: 20px;
            border-radius: 10px;
            max-width: 400px;
            margin: 20px auto;
            font-family: 'Courier New', monospace;
        }

        .receipt-header {
            text-align: center;
            border-bottom: 2px dashed #000;
            padding-bottom: 10px;
            margin-bottom: 15px;
        }

        .receipt-items {
            border-bottom: 1px dashed #000;
            padding-bottom: 10px;
            margin-bottom: 10px;
        }

        .receipt-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
        }

        .receipt-total {
            border-top: 2px dashed #000;
            padding-top: 10px;
            margin-top: 10px;
            font-weight: bold;
        }

        .cash-drawer-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .cash-drawer-stat {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            padding: 15px;
            text-align: center;
        }

        .cash-drawer-stat-value {
            font-size: 24px;
            font-weight: bold;
            margin: 10px 0;
            color: #4cd964;
        }

        .cash-drawer-stat-label {
            color: #aaa;
            font-size: 14px;
        }

        .product-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 15px;
            max-height: 500px;
            overflow-y: auto;
            padding: 10px;
            margin-bottom: 20px;
        }

        .product-grid::-webkit-scrollbar {
            width: 8px;
        }

        .product-grid::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
        }

        .product-grid::-webkit-scrollbar-thumb {
            background: rgba(0, 198, 255, 0.3);
            border-radius: 10px;
        }

        .product-grid::-webkit-scrollbar-thumb:hover {
            background: rgba(0, 198, 255, 0.5);
        }

        .product-grid-item {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }

        .product-grid-item:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: translateY(-2px);
        }

        .product-grid-item.selected {
            border-color: #00c6ff;
            background: rgba(0, 198, 255, 0.1);
        }

        .product-grid-item i {
            font-size: 30px;
            margin-bottom: 10px;
            color: #00c6ff;
        }

        .bulk-order-controls {
            margin-top: 10px;
        }

        .cashier-keypad {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin: 20px 0;
        }

        .keypad-btn {
            padding: 15px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            border: none;
            color: white;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .keypad-btn:hover {
            background: rgba(0, 198, 255, 0.2);
        }

        .keypad-btn.clear {
            background: rgba(220, 53, 69, 0.2);
            color: #dc3545;
        }

        .keypad-btn.clear:hover {
            background: rgba(220, 53, 69, 0.3);
        }

        .keypad-btn.enter {
            background: rgba(76, 217, 100, 0.2);
            color: #4cd964;
        }

        .keypad-btn.enter:hover {
            background: rgba(76, 217, 100, 0.3);
        }

        .cash-input-group {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
        }

        .change-display {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            text-align: center;
            font-size: 24px;
            color: #4cd964;
            font-weight: bold;
        }

        /* أنماط جديدة للتوصيل */
        .delivery-options {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
        }

        .delivery-option {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
            padding: 15px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }

        .delivery-option:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .delivery-option.active {
            border-color: #00c6ff;
            background: rgba(0, 198, 255, 0.1);
        }

        .delivery-option i {
            font-size: 24px;
            color: #00c6ff;
        }

        .delivery-option-info {
            flex: 1;
        }

        .delivery-option-title {
            font-weight: bold;
            margin-bottom: 5px;
        }

        .delivery-option-desc {
            color: #aaa;
            font-size: 14px;
        }

        .delivery-details {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            display: none;
        }

        .delivery-details.active {
            display: block;
        }

        /* أنماط جديدة لتعديل المدفوعات */
        .payment-edit-modal {
            max-width: 500px;
        }

        .payment-summary {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
        }

        .payment-history {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            max-height: 200px;
            overflow-y: auto;
        }

        .payment-history-item {
            display: flex;
            justify-content: space-between;
            padding: 10px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .payment-history-item:last-child {
            border-bottom: none;
        }

        .payment-method-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 5px;
            font-size: 12px;
            font-weight: bold;
            margin-right: 10px;
        }

        .badge-cash {
            background: rgba(52, 152, 219, 0.2);
            color: #3498db;
        }

        .badge-transfer {
            background: rgba(155, 89, 182, 0.2);
            color: #9b59b6;
        }

        .payment-proof-upload {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
        }

        /* أنماط جديدة للمدفوعات */
        .payment-tracker {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
        }

        .payment-progress {
            height: 10px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 5px;
            margin: 15px 0;
            overflow: hidden;
        }

        .payment-progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #4cd964, #2ecc71);
            border-radius: 5px;
            transition: width 0.3s ease;
        }

        .payment-summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .payment-summary-card {
            background: rgba(255, 255, 255, 0.08);
            border-radius: 10px;
            padding: 15px;
            text-align: center;
        }

        .payment-summary-value {
            font-size: 24px;
            font-weight: bold;
            margin: 10px 0;
        }

        .payment-summary-cash {
            color: #ffcc00;
        }

        .payment-summary-transfer {
            color: #9b59b6;
        }

        .payment-summary-total {
            color: #4cd964;
        }

        .payment-summary-remaining {
            color: #ff6b6b;
        }

        .payment-history-container {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 10px;
        }

        .payment-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .payment-item:last-child {
            border-bottom: none;
        }

        .badge-cash {
            background: rgba(255, 204, 0, 0.2);
            color: #ffcc00;
        }

        .badge-transfer {
            background: rgba(155, 89, 182, 0.2);
            color: #9b59b6;
        }

        .remaining-amount {
            background: rgba(255, 107, 107, 0.1);
            border: 2px solid rgba(255, 107, 107, 0.3);
            border-radius: 10px;
            padding: 15px;
            margin: 15px 0;
            text-align: center;
        }

        .remaining-amount h4 {
            color: #ff6b6b;
            margin-bottom: 10px;
        }

        .remaining-amount-value {
            font-size: 32px;
            font-weight: bold;
            color: #ff6b6b;
        }

        .payment-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .payment-btn {
            flex: 1;
            padding: 12px;
            border-radius: 10px;
            border: none;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all 0.3s ease;
        }

        .payment-btn-cash {
            background: rgba(255, 204, 0, 0.2);
            color: #ffcc00;
        }

        .payment-btn-cash:hover {
            background: rgba(255, 204, 0, 0.3);
        }

        .payment-btn-transfer {
            background: rgba(155, 89, 182, 0.2);
            color: #9b59b6;
        }

        .payment-btn-transfer:hover {
            background: rgba(155, 89, 182, 0.3);
        }

        /* أنماط جديدة لوضع طلب الكميات الكبيرة */
        #bulkOrderPanel {
            display: none;
            margin-top: 20px;
            padding: 15px;
            background: rgba(0, 198, 255, 0.1);
            border-radius: 10px;
            border: 2px solid rgba(0, 198, 255, 0.3);
        }

        /* أنماط جديدة لاختيار المنتج */
        .product-selection-area {
            margin-top: 20px;
            padding: 15px;
            background: rgba(0, 198, 255, 0.05);
            border-radius: 10px;
            border: 2px dashed rgba(0, 198, 255, 0.3);
        }

        .product-selection-area h4 {
            color: #00c6ff;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .product-selection-info {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            padding: 10px;
            margin: 10px 0;
        }

        .selected-product-name {
            font-weight: bold;
            color: #4cd964;
            margin-bottom: 5px;
        }

        .selected-product-details {
            display: flex;
            justify-content: space-between;
            color: #aaa;
            font-size: 14px;
        }

        /* أنماط جديدة لنظام البحث */
        .search-container {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .search-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
        }

        .search-header i {
            color: #00c6ff;
            font-size: 20px;
        }

        .search-input-group {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .search-input-group input {
            flex: 1;
            padding-left: 45px;
        }

        .search-input-container {
            position: relative;
            flex: 1;
        }

        .search-input-container i {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: #00c6ff;
            font-size: 18px;
        }

        .search-results-info {
            background: rgba(0, 198, 255, 0.1);
            border-radius: 8px;
            padding: 10px;
            margin-top: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .search-results-info span {
            color: #00c6ff;
            font-weight: 600;
        }

        .no-results {
            text-align: center;
            padding: 40px;
            color: #aaa;
        }

        .no-results i {
            font-size: 50px;
            margin-bottom: 15px;
            opacity: 0.5;
        }

        @media (max-width: 768px) {
            header {
                flex-direction: column;
                gap: 15px;
            }
            
            nav {
                width: 100%;
                justify-content: center;
            }
            
            .products {
                grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            }
            
            .stats {
                grid-template-columns: 1fr;
            }
            
            .button-group {
                flex-direction: column;
            }
            
            .bulk-actions {
                flex-direction: column;
            }
            
            .order-item-row {
                grid-template-columns: 1fr;
                gap: 5px;
            }
            
            .modal {
                width: 95%;
                padding: 15px;
            }
            
            .payment-proof-image {
                max-width: 200px;
                max-height: 150px;
            }
            
            .cashier-container {
                grid-template-columns: 1fr;
            }
            
            .product-grid {
                grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            }
            
            .cashier-keypad {
                grid-template-columns: repeat(3, 1fr);
            }
            
            .payment-methods {
                grid-template-columns: 1fr 1fr;
            }
            
            .payment-summary-grid {
                grid-template-columns: 1fr 1fr;
            }
            
            .payment-actions {
                flex-direction: column;
            }
            
            .search-input-group {
                flex-direction: column;
            }
        }

        @media (max-width: 480px) {
            .container {
                padding: 15px;
            }
            
            .products {
                grid-template-columns: 1fr;
            }
            
            .order-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 15px;
            }
            
            .modal {
                width: 95%;
                padding: 15px;
            }
            
            .payment-proof-image {
                max-width: 150px;
                max-height: 100px;
            }
            
            .payment-methods {
                grid-template-columns: 1fr;
            }
            
            .quick-actions {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .payment-summary-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>

<body>

<header>
    <div class="logo">
        <i class="fas fa-boxes"></i>
        <h1>مدير المتجر - نظام كاشير</h1>
    </div>
    <nav>
        <button id="productsBtn" onclick="showProducts()" class="active">
            <i class="fas fa-box-open"></i>
            المنتجات
        </button>
        <button id="ordersBtn" onclick="showOrders()">
            <i class="fas fa-shopping-cart"></i>
            الطلبات
        </button>
        <button id="cashierBtn" onclick="showCashier()">
            <i class="fas fa-cash-register"></i>
            الكاشير
        </button>
        <button id="paymentsBtn" onclick="showPaymentsReport()">
            <i class="fas fa-chart-bar"></i>
            تقرير المدفوعات
        </button>
    </nav>
</header>

<div class="container">

    <!-- PRODUCTS PAGE -->
    <div id="productsPage">
        <h2 class="page-title">
            <i class="fas fa-boxes"></i>
            إدارة المنتجات
        </h2>
        
        <div class="stats">
            <div class="stat-card products-stat">
                <i class="fas fa-box-open fa-2x"></i>
                <div class="stat-value" id="totalProducts">0</div>
                <div class="stat-label">المنتجات الإجمالية</div>
            </div>
            <div class="stat-card orders-stat">
                <i class="fas fa-shopping-cart fa-2x"></i>
                <div class="stat-value" id="totalOrders">0</div>
                <div class="stat-label">الطلبات الإجمالية</div>
            </div>
            <div class="stat-card sales-stat">
                <i class="fas fa-chart-line fa-2x"></i>
                <div class="stat-value" id="totalSales">0</div>
                <div class="stat-label">إجمالي المبيعات</div>
            </div>
        </div>

        <div class="card">
            <h3 id="formTitle"><i class="fas fa-plus-circle"></i> إضافة منتج جديد</h3>
            
            <input type="hidden" id="editProductId">
            
            <div class="input-group">
                <label for="name">اسم المنتج *</label>
                <input type="text" id="name" placeholder="أدخل اسم المنتج">
            </div>
            
            <div class="input-group">
                <label for="category">نوع المنتج *</label>
                <input type="text" id="category" placeholder="أدخل نوع المنتج (مثال: فيزا أمريكي، باسبور)">
                <div class="categories-list" id="commonCategories">
                    <span class="category-tag" onclick="setCategory('فيزا أمريكي')">فيزا أمريكي</span>
                    <span class="category-tag" onclick="setCategory('فيزا أوروبي')">فيزا أوروبي</span>
                    <span class="category-tag" onclick="setCategory('فيزا خليجي')">فيزا خليجي</span>
                    <span class="category-tag" onclick="setCategory('باسبور')">باسبور</span>
                    <span class="category-tag" onclick="setCategory('بطاقة هوية')">بطاقة هوية</span>
                    <span class="category-tag" onclick="setCategory('شهادات')">شهادات</span>
                    <span class="category-tag" onclick="setCategory('مستندات')">مستندات</span>
                    <span class="category-tag" onclick="setCategory('أخرى')">أخرى</span>
                </div>
            </div>
            
            <div class="input-group">
                <label for="price">السعر (بالجنيه) *</label>
                <input type="number" id="price" placeholder="أدخل سعر المنتج" min="0" step="0.01">
            </div>
            
            <div class="input-group">
                <label for="quantity">الكمية المتاحة *</label>
                <input type="number" id="quantity" placeholder="أدخل الكمية المتاحة" min="0" max="1000" oninput="validateProductQuantity()">
            </div>
            
            <div class="input-group">
                <label for="description">وصف المنتج (اختياري)</label>
                <textarea id="description" rows="3" placeholder="أدخل وصف للمنتج"></textarea>
            </div>
            
            <div class="input-group">
                <label>صورة المنتج (اختياري)</label>
                <div class="file-input-container">
                    <input type="file" id="image" accept="image/*">
                    <label for="image" class="file-input-label">
                        <i class="fas fa-cloud-upload-alt"></i>
                        <span id="file-name">اختر صورة للمنتج (اختياري)</span>
                    </label>
                </div>
                <div class="imgbb-info">
                    <i class="fas fa-info-circle"></i> سيتم رفع الصورة إلى IMGBB وتخزين الرابط تلقائياً
                </div>
                <div class="image-preview" id="imagePreview"></div>
            </div>
            
            <div class="button-group">
                <button class="main" id="addProductBtn" onclick="addProduct()">
                    <i class="fas fa-plus"></i>
                    إضافة المنتج
                </button>
                <button class="btn-update" id="updateProductBtn" style="display:none" onclick="updateProduct()">
                    <i class="fas fa-save"></i>
                    تحديث المنتج
                </button>
                <button class="btn-cancel" id="cancelEditBtn" style="display:none" onclick="cancelEdit()">
                    <i class="fas fa-times"></i>
                    إلغاء التعديل
                </button>
            </div>
        </div>

        <div class="card">
            <h3><i class="fas fa-list"></i> قائمة المنتجات</h3>
            
            <div class="bulk-actions">
                <button class="bulk-delete" onclick="showBulkDeleteModal()">
                    <i class="fas fa-trash"></i>
                    حذف منتجات محددة
                </button>
                <button class="main" onclick="refreshProducts()">
                    <i class="fas fa-sync-alt"></i>
                    تحديث القائمة
                </button>
            </div>
            
            <div class="products" id="productsList">
                <!-- المنتجات سيتم عرضها هنا -->
                <div class="empty-state">
                    <div class="loading"></div>
                    <h3>جاري تحميل المنتجات...</h3>
                </div>
            </div>
        </div>
    </div>

    <!-- ORDERS PAGE -->
    <div id="ordersPage" style="display:none">
        <h2 class="page-title">
            <i class="fas fa-shopping-cart"></i>
            إدارة الطلبات
        </h2>
        
        <div class="card">
            <h3><i class="fas fa-clipboard-list"></i> نظام البحث في الطلبات</h3>
            
            <!-- نظام البحث -->
            <div class="search-container">
                <div class="search-header">
                    <i class="fas fa-search"></i>
                    <h3>ابحث في الطلبات</h3>
                </div>
                
                <div class="search-input-group">
                    <div class="search-input-container">
                        <i class="fas fa-user"></i>
                        <input type="text" id="searchByName" placeholder="ابحث باسم العميل" onkeyup="searchOrders()">
                    </div>
                    
                    <div class="search-input-container">
                        <i class="fas fa-hashtag"></i>
                        <input type="text" id="searchByOrderNumber" placeholder="ابحث برقم الطلب" onkeyup="searchOrders()">
                    </div>
                    
                    <button class="main" onclick="clearSearch()" style="min-width: 100px;">
                        <i class="fas fa-times"></i>
                        مسح
                    </button>
                </div>
                
                <div class="search-input-group">
                    <div class="search-input-container">
                        <i class="fas fa-phone"></i>
                        <input type="text" id="searchByPhone" placeholder="ابحث برقم الهاتف" onkeyup="searchOrders()">
                    </div>
                    
                    <select id="searchByStatus" onchange="searchOrders()" style="flex: 1;">
                        <option value="">جميع الحالات</option>
                        <option value="pending">قيد الانتظار</option>
                        <option value="processing">قيد المعالجة</option>
                        <option value="shipped">تم الشحن</option>
                        <option value="delivered">تم التوصيل</option>
                        <option value="completed">مكتمل</option>
                        <option value="cancelled">ملغي</option>
                    </select>
                </div>
                
                <div id="searchResultsInfo" class="search-results-info" style="display: none;">
                    <span id="resultsCount">0 نتيجة</span>
                    <button onclick="clearSearch()" style="background: none; border: none; color: #00c6ff; cursor: pointer;">
                        <i class="fas fa-times"></i> إظهار الكل
                    </button>
                </div>
            </div>
            
            <div class="bulk-actions">
                <button class="bulk-delete" onclick="bulkDeleteOrders()">
                    <i class="fas fa-trash"></i>
                    حذف طلبات محددة
                </button>
                <button class="main" onclick="refreshOrders()">
                    <i class="fas fa-sync-alt"></i>
                    تحديث الطلبات
                </button>
            </div>
            
            <div class="orders-list" id="ordersList">
                <!-- الطلبات سيتم عرضها هنا -->
                <div class="empty-state">
                    <div class="loading"></div>
                    <h3>جاري تحميل الطلبات...</h3>
                </div>
            </div>
        </div>
        
        <div class="card">
            <h3><i class="fas fa-chart-pie"></i> إحصائيات الطلبات</h3>
            <div id="ordersStats">
                <!-- إحصائيات الطلبات ستظهر هنا -->
            </div>
        </div>
    </div>

    <!-- CASHIER PAGE -->
    <div id="cashierPage" style="display:none">
        <h2 class="page-title">
            <i class="fas fa-cash-register"></i>
            نظام الكاشير
        </h2>
        
        <div class="stats">
            <div class="stat-card products-stat">
                <i class="fas fa-box-open fa-2x"></i>
                <div class="stat-value" id="cashierProducts">0</div>
                <div class="stat-label">المنتجات المتاحة</div>
            </div>
            <div class="stat-card orders-stat">
                <i class="fas fa-shopping-cart fa-2x"></i>
                <div class="stat-value" id="cashierSales">0</div>
                <div class="stat-label">المبيعات اليوم</div>
            </div>
            <div class="stat-card sales-stat">
                <i class="fas fa-money-bill-wave fa-2x"></i>
                <div class="stat-value" id="cashierRevenue">0 ج.م</div>
                <div class="stat-label">الإيرادات اليوم</div>
            </div>
        </div>

        <div class="cashier-container">
            <!-- القسم الأيسر: المنتجات والسلة -->
            <div class="card">
                <h3><i class="fas fa-search"></i> البحث عن منتجات</h3>
                
                <div class="product-search-container">
                    <i class="fas fa-search"></i>
                    <input type="text" id="productSearch" placeholder="ابحث عن منتج بالاسم أو النوع..." onkeyup="searchProducts()">
                </div>
                
                <div class="product-grid" id="productGrid">
                    <!-- المنتجات ستظهر هنا -->
                </div>
                
                <!-- منطقة اختيار المنتج -->
                <div class="product-selection-area" id="productSelectionArea" style="display: none;">
                    <h4><i class="fas fa-check-circle"></i> المنتج المحدد</h4>
                    <div class="product-selection-info" id="selectedProductInfo">
                        <!-- معلومات المنتج المحدد ستظهر هنا -->
                    </div>
                    <div class="input-group" style="display: flex; gap: 10px; margin-top: 10px;">
                        <input type="number" id="selectedProductQuantity" placeholder="الكمية المطلوبة" min="1" max="100" value="1" style="flex: 1;">
                        <button class="whatsapp-btn small" onclick="addSelectedProductToCart()">
                            <i class="fas fa-plus"></i>
                            إضافة بالكمية
                        </button>
                    </div>
                </div>
                
                <div class="quick-actions">
                    <button class="quick-action-btn" onclick="addQuickProduct('فيزا أمريكي', 5000)">
                        <i class="fas fa-credit-card"></i>
                        <span>فيزا أمريكي</span>
                        <span style="font-size: 12px; color: #4cd964;">5000 ج.م</span>
                    </button>
                    <button class="quick-action-btn" onclick="addQuickProduct('فيزا أوروبي', 4000)">
                        <i class="fas fa-credit-card"></i>
                        <span>فيزا أوروبي</span>
                        <span style="font-size: 12px; color: #4cd964;">4000 ج.م</span>
                    </button>
                    <button class="quick-action-btn" onclick="addQuickProduct('باسبور', 3000)">
                        <i class="fas fa-passport"></i>
                        <span>باسبور</span>
                        <span style="font-size: 12px; color: #4cd964;">3000 ج.م</span>
                    </button>
                    <button class="quick-action-btn" onclick="addQuickProduct('بطاقة هوية', 2000)">
                        <i class="fas fa-id-card"></i>
                        <span>بطاقة هوية</span>
                        <span style="font-size: 12px; color: #4cd964;">2000 ج.م</span>
                    </button>
                </div>
                
                <!-- لوحة طلب الكميات الكبيرة -->
                <div class="quick-actions" style="margin-top: 20px;">
                    <button class="quick-action-btn" onclick="enableBulkOrder()">
                        <i class="fas fa-boxes"></i>
                        <span>طلب كميات كبيرة</span>
                        <span style="font-size: 12px; color: #ffcc00;">(حتى 100 قطعة)</span>
                    </button>
                    <button class="quick-action-btn" onclick="disableBulkOrder()">
                        <i class="fas fa-cart-plus"></i>
                        <span>طلب عادي</span>
                    </button>
                </div>
                
                <div id="bulkOrderPanel">
                    <h4><i class="fas fa-boxes"></i> لوحة طلب الكميات الكبيرة</h4>
                    <p style="color: #ccc; margin-bottom: 15px;">اختر منتجاً أولاً ثم أدخل الكمية المطلوبة</p>
                    
                    <div class="input-group" style="display: flex; gap: 10px;">
                        <input type="number" id="bulkQuantity" placeholder="الكمية المطلوبة" min="1" max="100" value="1" style="flex: 1;">
                        <button class="whatsapp-btn small" onclick="addWithBulkQuantity()">
                            <i class="fas fa-plus"></i>
                            إضافة بالكمية
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- القسم الأيمن: سلة المشتريات والدفع -->
            <div class="card">
                <h3><i class="fas fa-shopping-cart"></i> سلة المشتريات</h3>
                
                <div class="cart-items" id="cartItems">
                    <!-- العناصر في السلة ستظهر هنا -->
                    <div class="empty-state">
                        <i class="fas fa-shopping-cart"></i>
                        <h3>السلة فارغة</h3>
                        <p>أضف منتجات من القائمة</p>
                    </div>
                </div>
                
                <div class="cart-summary">
                    <div class="summary-row">
                        <span>المجموع الفرعي:</span>
                        <span id="subtotal">0.00 ج.م</span>
                    </div>
                    <div class="summary-row">
                        <span>الخصم:</span>
                        <span id="discount">0.00 ج.م</span>
                    </div>
                    <div class="summary-row" id="shippingRow" style="display: none;">
                        <span>مصاريف الشحن:</span>
                        <span id="shipping">0.00 ج.م</span>
                    </div>
                    <div class="summary-row total">
                        <span>الإجمالي:</span>
                        <span id="total">0.00 ج.م</span>
                    </div>
                </div>
                
                <div class="input-group">
                    <label>خصم (ج.م)</label>
                    <input type="number" id="discountInput" placeholder="أدخل قيمة الخصم" min="0" step="0.01" onchange="updateDiscount()">
                </div>
                
                <div class="delivery-options">
                    <h4><i class="fas fa-truck"></i> طريقة التوصيل</h4>
                    <div class="delivery-option active" onclick="selectDeliveryMethod('pickup')">
                        <i class="fas fa-store"></i>
                        <div class="delivery-option-info">
                            <div class="delivery-option-title">استلام من المتجر</div>
                            <div class="delivery-option-desc">العميل يستلم المنتج من المحل</div>
                        </div>
                    </div>
                    <div class="delivery-option" onclick="selectDeliveryMethod('delivery')">
                        <i class="fas fa-truck"></i>
                        <div class="delivery-option-info">
                            <div class="delivery-option-title">توصيل للعميل</div>
                            <div class="delivery-option-desc">شحن المنتج إلى عنوان العميل</div>
                        </div>
                    </div>
                </div>
                
                <div class="delivery-details" id="deliveryDetails">
                    <h4><i class="fas fa-map-marker-alt"></i> عنوان التوصيل</h4>
                    <div class="input-group">
                        <label>العنوان التفصيلي</label>
                        <textarea id="deliveryAddress" rows="3" placeholder="أدخل العنوان الكامل للعميل"></textarea>
                    </div>
                    <div class="input-group">
                        <label>مصاريف الشحن (ج.م)</label>
                        <input type="number" id="shippingCost" placeholder="أدخل تكلفة الشحن" min="0" step="0.01" onchange="updateShipping()">
                    </div>
                </div>
                
                <div class="payment-methods">
                    <div class="payment-method active" onclick="selectPaymentMethod('cash')">
                        <i class="fas fa-money-bill-wave"></i>
                        <div>نقداً</div>
                    </div>
                    <div class="payment-method" onclick="selectPaymentMethod('transfer')">
                        <i class="fas fa-university"></i>
                        <div>تحويل بنكي</div>
                    </div>
                </div>
                
                <div class="cash-input-group" id="cashInputGroup">
                    <h4><i class="fas fa-money-bill-wave"></i> الدفع نقداً</h4>
                    <div class="input-group">
                        <label>المبلغ المدفوع</label>
                        <input type="number" id="cashPaid" placeholder="أدخل المبلغ المدفوع" min="0" step="0.01" onchange="calculateChange()">
                    </div>
                    <div class="change-display" id="changeDisplay" style="display: none;">
                        المتبقي: <span id="changeAmount">0.00</span> ج.م
                    </div>
                    <div class="cashier-keypad">
                        <button class="keypad-btn" onclick="addToCashPaid('100')">100</button>
                        <button class="keypad-btn" onclick="addToCashPaid('200')">200</button>
                        <button class="keypad-btn" onclick="addToCashPaid('500')">500</button>
                        <button class="keypad-btn" onclick="addToCashPaid('1000')">1000</button>
                        <button class="keypad-btn" onclick="addToCashPaid('50')">50</button>
                        <button class="keypad-btn" onclick="addToCashPaid('20')">20</button>
                        <button class="keypad-btn" onclick="addToCashPaid('10')">10</button>
                        <button class="keypad-btn" onclick="addToCashPaid('5')">5</button>
                        <button class="keypad-btn" onclick="addToCashPaid('1')">1</button>
                        <button class="keypad-btn clear" onclick="clearCashPaid()">
                            <i class="fas fa-backspace"></i>
                        </button>
                        <button class="keypad-btn" onclick="addToCashPaid('0')">0</button>
                        <button class="keypad-btn enter" onclick="processCashPayment()">
                            <i class="fas fa-check"></i>
                        </button>
                    </div>
                </div>
                
                <div class="payment-proof-upload" id="transferProofGroup" style="display: none;">
                    <h4><i class="fas fa-file-invoice"></i> إثبات التحويل البنكي</h4>
                    <div class="file-input-container">
                        <input type="file" id="transferProof" accept="image/*">
                        <label for="transferProof" class="file-input-label">
                            <i class="fas fa-cloud-upload-alt"></i>
                            <span id="transfer-file-name">اختر صورة إثبات التحويل</span>
                        </label>
                    </div>
                    <div class="image-preview" id="transferProofPreview"></div>
                    <div class="input-group" style="margin-top: 15px;">
                        <label>مبلغ التحويل المدفوع (ج.م) *</label>
                        <input type="number" id="transferAmount" placeholder="أدخل المبلغ الذي تحول إليه العميل" min="0" step="0.01">
                    </div>
                </div>
                
                <div class="customer-info-input">
                    <h4><i class="fas fa-user"></i> معلومات العميل</h4>
                    <div class="input-group">
                        <label>اسم العميل *</label>
                        <input type="text" id="customerName" placeholder="أدخل اسم العميل">
                    </div>
                    <div class="input-group">
                        <label>رقم الهاتف *</label>
                        <input type="tel" id="customerPhone" placeholder="أدخل رقم الهاتف">
                    </div>
                </div>
                
                <div class="button-group">
                    <button class="main" onclick="processSale()">
                        <i class="fas fa-check-circle"></i>
                        إنهاء البيع
                    </button>
                    <button class="btn-cancel" onclick="clearCart()">
                        <i class="fas fa-trash"></i>
                        مسح السلة
                    </button>
                </div>
            </div>
        </div>
        
        <div class="card" style="margin-top: 20px;">
            <h3><i class="fas fa-history"></i> المبيعات الحديثة</h3>
            <div id="recentSales">
                <!-- المبيعات الأخيرة ستظهر هنا -->
                <div class="orders-list">
                    <div class="empty-state" style="padding: 20px;">
                        <i class="fas fa-history"></i>
                        <h4>لا توجد مبيعات حديثة</h4>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- PAYMENTS REPORT PAGE -->
    <div id="paymentsPage" style="display:none">
        <h2 class="page-title">
            <i class="fas fa-chart-bar"></i>
            تقرير المدفوعات
        </h2>
        
        <div class="card">
            <h3><i class="fas fa-filter"></i> فلترة المدفوعات</h3>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-top: 15px;">
                <div class="input-group">
                    <label>من تاريخ</label>
                    <input type="date" id="startDate">
                </div>
                <div class="input-group">
                    <label>إلى تاريخ</label>
                    <input type="date" id="endDate">
                </div>
                <div class="input-group">
                    <label>طريقة الدفع</label>
                    <select id="paymentMethodFilter">
                        <option value="all">الكل</option>
                        <option value="cash">نقداً</option>
                        <option value="transfer">تحويل</option>
                    </select>
                </div>
                <button class="main" onclick="loadPaymentsReport()" style="align-self: flex-end;">
                    <i class="fas fa-search"></i>
                    بحث
                </button>
            </div>
        </div>
        
        <div class="card">
            <h3><i class="fas fa-chart-pie"></i> إحصائيات المدفوعات</h3>
            <div id="paymentsStats">
                <!-- إحصائيات المدفوعات ستظهر هنا -->
            </div>
        </div>
        
        <div class="card">
            <h3><i class="fas fa-list"></i> تفاصيل المدفوعات</h3>
            <div id="paymentsDetails">
                <!-- تفاصيل المدفوعات ستظهر هنا -->
            </div>
        </div>
    </div>

</div>

<!-- نافذة حذف جماعي للمنتجات -->
<div class="modal-overlay" id="bulkDeleteModal">
    <div class="modal">
        <div class="modal-header">
            <h3 class="modal-title"><i class="fas fa-trash"></i> حذف منتجات محددة</h3>
            <button class="close-modal" onclick="closeBulkDeleteModal()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div id="bulkDeleteProductsList">
            <!-- قائمة المنتجات للاختيار -->
        </div>
        <div class="button-group" style="margin-top: 20px;">
            <button class="btn-delete" onclick="confirmBulkDelete()">
                <i class="fas fa-trash"></i>
                حذف المحدد
            </button>
            <button class="btn-cancel" onclick="closeBulkDeleteModal()">
                <i class="fas fa-times"></i>
                إلغاء
            </button>
        </div>
    </div>
</div>

<!-- نافذة تفاصيل الطلب -->
<div class="modal-overlay" id="orderDetailsModal">
    <div class="modal order-details-modal">
        <div class="modal-header">
            <h3 class="modal-title"><i class="fas fa-file-invoice"></i> تفاصيل الطلب</h3>
            <button class="close-modal" onclick="closeOrderDetailsModal()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        
        <div id="orderDetailsContent" style="max-height: 70vh; overflow-y: auto;">
            <!-- تفاصيل الطلب ستظهر هنا -->
        </div>
        
        <div class="button-group" style="margin-top: 20px;">
            <button class="btn-cancel" onclick="closeOrderDetailsModal()">
                <i class="fas fa-times"></i>
                إغلاق
            </button>
        </div>
    </div>
</div>

<!-- نافذة تأكيد الحذف -->
<div class="modal-overlay" id="confirmDeleteModal">
    <div class="modal">
        <div class="modal-header">
            <h3 class="modal-title"><i class="fas fa-exclamation-triangle"></i> تأكيد الحذف</h3>
            <button class="close-modal" onclick="closeConfirmDeleteModal()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <p id="deleteMessage" style="margin-bottom: 20px;">هل أنت متأكد من حذف هذا العنصر؟</p>
        <div class="button-group">
            <button class="btn-delete" onclick="confirmDelete()">
                <i class="fas fa-trash"></i>
                نعم، احذف
            </button>
            <button class="btn-cancel" onclick="closeConfirmDeleteModal()">
                <i class="fas fa-times"></i>
                إلغاء
            </button>
        </div>
    </div>
</div>

<!-- نافذة تغيير حالة الطلب -->
<div class="modal-overlay" id="changeStatusModal">
    <div class="modal">
        <div class="modal-header">
            <h3 class="modal-title"><i class="fas fa-edit"></i> تغيير حالة الطلب</h3>
            <button class="close-modal" onclick="closeChangeStatusModal()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        
        <div class="input-group">
            <label for="newStatus">الحالة الجديدة</label>
            <select id="newStatus">
                <option value="pending">قيد الانتظار</option>
                <option value="processing">قيد المعالجة</option>
                <option value="shipped">تم الشحن</option>
                <option value="delivered">تم التوصيل</option>
                <option value="completed">مكتمل</option>
                <option value="cancelled">ملغي</option>
            </select>
        </div>
        
        <div class="input-group">
            <label for="statusNotes">ملاحظات إضافية (اختياري)</label>
            <textarea id="statusNotes" rows="3" placeholder="أضف ملاحظات لتحديث العميل"></textarea>
        </div>
        
        <div class="whatsapp-info">
            <h4><i class="fab fa-whatsapp"></i> إرسال التحديث عبر واتساب</h4>
            <p style="font-size: 14px; color: #ccc; margin-bottom: 10px;">
                سيتم إرسال رسالة إلى العميل عبر واتساب لتحديثه بحالة الطلب الجديدة
            </p>
            <div class="checkbox-group">
                <input type="checkbox" id="sendWhatsApp" checked>
                <label for="sendWhatsApp">إرسال تحديث الحالة عبر واتساب</label>
            </div>
        </div>
        
        <input type="hidden" id="statusOrderId">
        <input type="hidden" id="statusCustomerPhone">
        <input type="hidden" id="statusOrderNumber">
        
        <div class="button-group">
            <button class="btn-update" onclick="updateOrderStatus()">
                <i class="fas fa-save"></i>
                حفظ التغييرات
            </button>
            <button class="btn-cancel" onclick="closeChangeStatusModal()">
                <i class="fas fa-times"></i>
                إلغاء
            </button>
        </div>
    </div>
</div>

<!-- نافذة إرسال رسالة واتساب -->
<div class="modal-overlay" id="whatsappModal">
    <div class="modal whatsapp-modal">
        <div class="modal-header">
            <h3 class="modal-title"><i class="fab fa-whatsapp"></i> إرسال تحديث الحالة</h3>
            <button class="close-modal" onclick="closeWhatsAppModal()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        
        <div class="whatsapp-info">
            <h4><i class="fas fa-info-circle"></i> معلومات الإرسال</h4>
            <div class="info-row">
                <span class="info-label">إلى:</span>
                <span class="info-value" id="whatsappCustomerPhone"></span>
            </div>
            <div class="info-row">
                <span class="info-label">رقم الطلب:</span>
                <span class="info-value" id="whatsappOrderNumber"></span>
            </div>
        </div>
        
        <div class="whatsapp-preview">
            <h5>معاينة الرسالة:</h5>
            <pre id="whatsappMessagePreview"></pre>
        </div>
        
        <div class="button-group">
            <button class="whatsapp-btn" onclick="sendWhatsAppMessage()">
                <i class="fab fa-whatsapp"></i>
                فتح واتساب للإرسال
            </button>
            <button class="btn-cancel" onclick="closeWhatsAppModal()">
                <i class="fas fa-times"></i>
                إلغاء
            </button>
        </div>
        
        <p style="font-size: 12px; color: #aaa; margin-top: 15px; text-align: center;">
            <i class="fas fa-info-circle"></i> سيتم فتح واتساب مع الرسالة المحضرة، يمكنك إرسالها مباشرة إلى العميل
        </p>
    </div>
</div>

<!-- نافذة معاينة صورة الدفع -->
<div class="modal-overlay" id="paymentProofModal">
    <div class="modal">
        <div class="modal-header">
            <h3 class="modal-title"><i class="fas fa-image"></i> صورة إثبات الدفع</h3>
            <button class="close-modal" onclick="closePaymentProofModal()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div id="paymentProofContent" style="text-align: center;">
            <!-- صورة الدفع ستظهر هنا -->
        </div>
        <div class="button-group" style="margin-top: 20px;">
            <button class="btn-cancel" onclick="closePaymentProofModal()">
                <i class="fas fa-times"></i>
                إغلاق
            </button>
        </div>
    </div>
</div>

<!-- نافذة الفاتورة -->
<div class="modal-overlay" id="invoiceModal">
    <div class="modal" style="max-width: 800px;">
        <div class="modal-header">
            <h3 class="modal-title"><i class="fas fa-receipt"></i> فاتورة البيع</h3>
            <button class="close-modal" onclick="closeInvoiceModal()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        
        <div class="receipt-container" id="invoiceContent">
            <!-- محتوى الفاتورة سيظهر هنا -->
        </div>
        
        <div class="button-group" style="margin-top: 20px;">
            <button class="whatsapp-btn" onclick="sendInvoiceViaWhatsApp()">
                <i class="fab fa-whatsapp"></i>
                إرسال عبر واتساب
            </button>
            <button class="main" onclick="printInvoice()">
                <i class="fas fa-print"></i>
                طباعة الفاتورة
            </button>
            <button class="btn-cancel" onclick="closeInvoiceModal()">
                <i class="fas fa-times"></i>
                إغلاق
            </button>
        </div>
    </div>
</div>

<!-- نافذة تعديل المدفوعات -->
<div class="modal-overlay" id="editPaymentModal">
    <div class="modal payment-edit-modal">
        <div class="modal-header">
            <h3 class="modal-title"><i class="fas fa-money-bill-wave"></i> تعديل المدفوعات</h3>
            <button class="close-modal" onclick="closeEditPaymentModal()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        
        <div id="editPaymentContent">
            <!-- محتوى تعديل المدفوعات سيظهر هنا -->
        </div>
    </div>
</div>

<!-- نافذة إدارة المدفوعات -->
<div class="modal-overlay" id="managePaymentsModal">
    <div class="modal payment-edit-modal">
        <div class="modal-header">
            <h3 class="modal-title"><i class="fas fa-money-bill-wave"></i> إدارة المدفوعات</h3>
            <button class="close-modal" onclick="closeManagePaymentsModal()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        
        <div id="managePaymentsContent">
            <!-- محتوى إدارة المدفوعات سيظهر هنا -->
        </div>
    </div>
</div>

<!-- إشعارات -->
<div id="notification" class="notification">
    <div class="notification-content">
        <i class="fas fa-check-circle"></i>
        <div>
            <h4 id="notification-title">تمت العملية بنجاح</h4>
            <p id="notification-message">تم إضافة المنتج بنجاح</p>
        </div>
    </div>
    <button class="close-notification" onclick="hideNotification()">
        <i class="fas fa-times"></i>
    </button>
</div>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

<script>
    // ========== تهيئة Firebase ==========
    const firebaseConfig = {
        apiKey: "AIzaSyBDWwS0oydPz7jkZl-fBR0G_0ifVpVs4Pg",
        authDomain: "abozahra-43ac3.firebaseapp.com",
        projectId: "abozahra-43ac3",
        storageBucket: "abozahra-43ac3.firebasestorage.app",
        messagingSenderId: "556658053272",
        appId: "1:556658053272:web:15424479721be40b4980ed",
        measurementId: "G-TEJF82PXET"
    };

    // تهيئة Firebase
    let db;
    try {
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        db = firebase.firestore();
        console.log("✅ Firebase initialized successfully");
    } catch (error) {
        console.error("❌ Error initializing Firebase:", error);
        showNotification("خطأ", "فشل في تهيئة قاعدة البيانات", "error");
    }

    // ========== متغيرات التطبيق ==========
    const IMGBB_API_KEY = "9bd15b9b262c7a1c8e836dd8d921ef60";
    const DEFAULT_IMAGE = "https://images.unsplash.com/photo-1505740420928-5e560c06d30e?ixlib=rb-4.0.3&auto=format&fit=crop&w=800&q=80";

    let allProducts = [];
    let allOrders = [];
    let selectedProductsForDelete = new Set();
    let selectedOrdersForDelete = new Set();
    let itemToDelete = null;
    let deleteType = null;
    let currentOrderId = null;
    let currentOrderData = null;
    
    // متغيرات نظام الكاشير
    let cart = [];
    let selectedPaymentMethod = 'cash';
    let selectedDeliveryMethod = 'pickup';
    let shippingCost = 0;
    let transferProofImage = null;
    let currentSale = null;
    let dailyStats = {
        salesCount: 0,
        revenue: 0,
        transactions: []
    };
    
    // متغير وضع طلب الكميات الكبيرة
    let bulkOrderMode = false;
    
    // متغير المنتج المحدد
    let selectedProduct = null;
    
    // متغيرات البحث
    let searchActive = false;
    let searchResults = [];

    // ========== دوال مساعدة ==========

    // دالة لتعيين نوع المنتج من الأيقونات
    window.setCategory = (category) => {
        document.getElementById("category").value = category;
    };

    // دالة لتحويل الصورة إلى base64
    function readFileAsDataURL(file) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = () => resolve(reader.result);
            reader.onerror = reject;
            reader.readAsDataURL(file);
        });
    }

    // دالة لرفع الصورة إلى IMGBB
    async function uploadImageToImgBB(file) {
        try {
            console.log("🚀 بدء رفع الصورة إلى IMGBB...");
            
            const base64Image = await readFileAsDataURL(file);
            const base64Data = base64Image.split(',')[1];
            
            const formData = new FormData();
            formData.append('key', IMGBB_API_KEY);
            formData.append('image', base64Data);
            formData.append('name', file.name || 'product_image');
            
            const response = await fetch('https://api.imgbb.com/1/upload', {
                method: 'POST',
                body: formData
            });
            
            const data = await response.json();
            
            if (data.success) {
                console.log("✅ تم رفع الصورة بنجاح:", data.data.url);
                return {
                    success: true,
                    url: data.data.url,
                    thumbUrl: data.data.thumb?.url || data.data.url,
                    deleteUrl: data.data.delete_url,
                    displayUrl: data.data.display_url
                };
            } else {
                throw new Error(data.error?.message || 'فشل في رفع الصورة');
            }
            
        } catch (error) {
            console.error("❌ خطأ في رفع الصورة إلى IMGBB:", error);
            throw error;
        }
    }

    // دالة لحساب حالة الدفع (معدلة)
    function calculatePaymentStatus(paid, total) {
        if (paid >= total) return 'paid'; // مدفوع بالكامل
        if (paid > 0 && paid < total) return 'partial'; // مدفوع جزئياً
        if (paid === 0) return 'unpaid'; // غير مدفوع
        return 'pending';
    }

    // دالة لتحديث حالة الطلب بناءً على المدفوعات
    function updateOrderStatusBasedOnPayment(paymentStatus, currentStatus) {
        // حالة الطلب تبدأ دائماً "قيد الانتظار" ولا تتغير تلقائياً
        // فقط أنت اللي بتعدل عليها يدوياً
        return currentStatus || 'pending';
    }

    // دالة لإنشاء رسالة تحديث الحالة للعميل
    function createStatusUpdateMessage(orderNumber, customerName, newStatus, notes = '') {
        const statusMessages = {
            'pending': 'قيد الانتظار',
            'processing': 'قيد المعالجة',
            'shipped': 'تم الشحن',
            'delivered': 'تم التوصيل',
            'completed': 'مكتمل',
            'cancelled': 'ملغي'
        };
        
        const statusText = statusMessages[newStatus] || newStatus;
        
        let message = `مرحباً ${customerName} 👋\n\n`;
        message += `*تحديث حالة طلبك*\n`;
        message += `📦 *رقم الطلب:* ${orderNumber}\n`;
        message += `🔄 *الحالة الجديدة:* ${statusText}\n\n`;
        
        if (notes) {
            message += `📝 *ملاحظات:* ${notes}\n\n`;
        }
        
        message += `---\n`;
        message += `شكراً لثقتك بنا! 😊\n`;
        message += `متجر Abo Zahra - للتسوق الإلكتروني\n`;
        message += `📞 للاستفسار: 01029149379`;
        
        return message;
    }

    // دالة لفتح واتساب مع رسالة مخصصة
    function openWhatsAppWithMessage(phone, message) {
        // تنظيف رقم الهاتف
        const cleanedPhone = phone.replace(/\D/g, '');
        
        // إضافة رمز الدولة إذا لم يكن موجوداً
        let finalPhone = cleanedPhone;
        if (!finalPhone.startsWith('2')) {
            finalPhone = '2' + finalPhone;
        }
        
        // ترميز الرسالة
        const encodedMessage = encodeURIComponent(message);
        
        // إنشاء رابط واتساب
        const whatsappUrl = `https://wa.me/${finalPhone}?text=${encodedMessage}`;
        
        // فتح الرابط في نافذة جديدة
        window.open(whatsappUrl, '_blank');
        
        return whatsappUrl;
    }

    // دالة لعرض الإشعارات
    function showNotification(title, message, type = "info") {
        const notification = document.getElementById("notification");
        const notificationTitle = document.getElementById("notification-title");
        const notificationMessage = document.getElementById("notification-message");
        
        if (!notification || !notificationTitle || !notificationMessage) {
            console.log(`[${type.toUpperCase()}] ${title}: ${message}`);
            return;
        }
        
        notificationTitle.textContent = title;
        notificationMessage.textContent = message;
        
        // تغيير لون الإشعار حسب النوع
        notification.style.borderRightColor = 
            type === "success" ? "#4cd964" : 
            type === "error" ? "#ff3b30" : 
            type === "warning" ? "#ffcc00" : "#00c6ff";
        
        // تغيير الأيقونة حسب النوع
        const icon = notification.querySelector("i");
        if (icon) {
            icon.className = 
                type === "success" ? "fas fa-check-circle" : 
                type === "error" ? "fas fa-exclamation-circle" : 
                type === "warning" ? "fas fa-exclamation-triangle" : "fas fa-info-circle";
        }
        
        notification.classList.add("show");
        
        setTimeout(() => {
            hideNotification();
        }, 5000);
    }

    // إخفاء الإشعار
    window.hideNotification = () => {
        const notification = document.getElementById("notification");
        if (notification) notification.classList.remove("show");
    };

    // ========== نظام البحث في الطلبات ==========

    // دالة البحث في الطلبات
    window.searchOrders = () => {
        const searchByName = document.getElementById("searchByName").value.toLowerCase().trim();
        const searchByOrderNumber = document.getElementById("searchByOrderNumber").value.toLowerCase().trim();
        const searchByPhone = document.getElementById("searchByPhone").value.toLowerCase().trim();
        const searchByStatus = document.getElementById("searchByStatus").value;
        
        const searchResultsInfo = document.getElementById("searchResultsInfo");
        const resultsCount = document.getElementById("resultsCount");
        
        // التحقق إذا كان هناك بحث فعال
        if (!searchByName && !searchByOrderNumber && !searchByPhone && !searchByStatus) {
            // إذا لم يكن هناك بحث، عرض الكل
            displayAllOrders();
            searchResultsInfo.style.display = "none";
            searchActive = false;
            return;
        }
        
        searchActive = true;
        searchResults = [];
        
        // فلترة الطلبات بناءً على معايير البحث
        allOrders.forEach(order => {
            let match = true;
            
            // البحث باسم العميل
            if (searchByName) {
                const customerName = order.customer?.name?.toLowerCase() || '';
                if (!customerName.includes(searchByName)) {
                    match = false;
                }
            }
            
            // البحث برقم الطلب
            if (searchByOrderNumber && match) {
                const orderNumber = order.orderNumber?.toLowerCase() || `ord-${order.id.slice(0, 8)}`;
                if (!orderNumber.includes(searchByOrderNumber)) {
                    match = false;
                }
            }
            
            // البحث برقم الهاتف
            if (searchByPhone && match) {
                const customerPhone = order.customer?.phone?.toLowerCase() || '';
                if (!customerPhone.includes(searchByPhone)) {
                    match = false;
                }
            }
            
            // البحث بالحالة
            if (searchByStatus && match) {
                const orderStatus = order.status || 'pending';
                if (orderStatus !== searchByStatus) {
                    match = false;
                }
            }
            
            if (match) {
                searchResults.push(order);
            }
        });
        
        // عرض نتائج البحث
        displaySearchResults(searchResults);
        
        // تحديث معلومات نتائج البحث
        if (searchResults.length === 0) {
            resultsCount.textContent = "0 نتيجة";
            searchResultsInfo.style.display = "flex";
        } else {
            resultsCount.textContent = `${searchResults.length} نتيجة`;
            searchResultsInfo.style.display = "flex";
        }
    };

    // عرض نتائج البحث
    function displaySearchResults(results) {
        const ordersList = document.getElementById("ordersList");
        
        if (results.length === 0) {
            ordersList.innerHTML = `
                <div class="no-results">
                    <i class="fas fa-search"></i>
                    <h3>لا توجد نتائج للبحث</h3>
                    <p>حاول تغيير كلمات البحث أو المعايير</p>
                    <button onclick="clearSearch()" style="margin-top: 15px; padding: 10px 20px; background: #00c6ff; color: #000; border: none; border-radius: 8px; cursor: pointer;">
                        <i class="fas fa-redo"></i> عرض جميع الطلبات
                    </button>
                </div>
            `;
            return;
        }
        
        let ordersHTML = "";
        
        results.forEach(order => {
            // تنسيق التاريخ
            const orderDate = order.createdAt ? 
                order.createdAt.toDate().toLocaleDateString('ar-EG') : 
                'غير محدد';

            // اسم العميل
            const customerName = order.customer ? 
                (order.customer.name || 'غير محدد') : 
                'غير محدد';

            // رقم الطلب
            const orderNumber = order.orderNumber || `ORD-${order.id.slice(0, 8)}`;

            // حساب إجمالي الطلب
            let orderTotal = 0;
            if (order.summary && order.summary.total) {
                orderTotal = order.summary.total;
            } else if (order.payment && order.payment.total) {
                orderTotal = order.payment.total;
            } else if (order.total) {
                orderTotal = order.total;
            }

            // حالة الطلب بالعربية
            const status = order.status || 'pending';
            const statusText = {
                'pending': 'قيد الانتظار',
                'processing': 'قيد المعالجة',
                'shipped': 'تم الشحن',
                'delivered': 'تم التوصيل',
                'completed': 'مكتمل',
                'cancelled': 'ملغي'
            }[status] || status;

            // فئة حالة الطلب
            const statusClass = {
                'pending': 'pending',
                'processing': 'processing',
                'shipped': 'shipped',
                'delivered': 'delivered',
                'completed': 'completed',
                'cancelled': 'cancelled'
            }[status] || 'pending';

            // حالة إرسال واتساب
            const whatsappSent = order.whatsappSent ? 
                '<span style="color: #4cd964; font-size: 12px; margin-right: 5px;"><i class="fab fa-whatsapp"></i> تم الإرسال</span>' : 
                '<span style="color: #ffcc00; font-size: 12px; margin-right: 5px;"><i class="fab fa-whatsapp"></i> لم يرسل</span>';

            ordersHTML += `
                <div class="order-item">
                    <div class="checkbox-group">
                        <input type="checkbox" id="order-${order.id}" onchange="toggleOrderSelection('${order.id}')">
                        <label for="order-${order.id}">تحديد</label>
                    </div>
                    <div class="order-info">
                        <h4>${orderNumber} ${whatsappSent}</h4>
                        <p>العميل: ${customerName}</p>
                        <div class="order-details">
                            <span><i class="fas fa-calendar"></i> ${orderDate}</span>
                            <span><i class="fas fa-money-bill"></i> ${orderTotal.toFixed(2)} جنيه</span>
                            <span><i class="fas fa-box"></i> ${order.items ? order.items.length : 0} منتج</span>
                        </div>
                    </div>
                    <div class="order-status status-${statusClass}">
                        ${statusText}
                    </div>
                    <div class="action-buttons">
                        <button onclick="viewOrderDetails('${order.id}')" class="btn-edit">
                            <i class="fas fa-eye"></i> تفاصيل
                        </button>
                        <button onclick="manageOrderPayments('${order.id}')" class="btn-edit">
                            <i class="fas fa-money-bill-wave"></i>
                            المدفوعات
                        </button>
                        <button onclick="showDeleteConfirmation('${order.id}', 'order', 'طلب')" class="btn-delete">
                            <i class="fas fa-trash"></i> حذف
                        </button>
                    </div>
                </div>
            `;
        });

        ordersList.innerHTML = ordersHTML;
    }

    // عرض جميع الطلبات
    function displayAllOrders() {
        const ordersList = document.getElementById("ordersList");
        
        if (allOrders.length === 0) {
            ordersList.innerHTML = `
                <div class="empty-state">
                    <i class="fas fa-shopping-cart"></i>
                    <h3>لا توجد طلبات</h3>
                    <p>لم يتم إضافة أي طلبات بعد.</p>
                </div>
            `;
            return;
        }
        
        let ordersHTML = "";
        
        allOrders.forEach(order => {
            // تنسيق التاريخ
            const orderDate = order.createdAt ? 
                order.createdAt.toDate().toLocaleDateString('ar-EG') : 
                'غير محدد';

            // اسم العميل
            const customerName = order.customer ? 
                (order.customer.name || 'غير محدد') : 
                'غير محدد';

            // رقم الطلب
            const orderNumber = order.orderNumber || `ORD-${order.id.slice(0, 8)}`;

            // حساب إجمالي الطلب
            let orderTotal = 0;
            if (order.summary && order.summary.total) {
                orderTotal = order.summary.total;
            } else if (order.payment && order.payment.total) {
                orderTotal = order.payment.total;
            } else if (order.total) {
                orderTotal = order.total;
            }

            // حالة الطلب بالعربية
            const status = order.status || 'pending';
            const statusText = {
                'pending': 'قيد الانتظار',
                'processing': 'قيد المعالجة',
                'shipped': 'تم الشحن',
                'delivered': 'تم التوصيل',
                'completed': 'مكتمل',
                'cancelled': 'ملغي'
            }[status] || status;

            // فئة حالة الطلب
            const statusClass = {
                'pending': 'pending',
                'processing': 'processing',
                'shipped': 'shipped',
                'delivered': 'delivered',
                'completed': 'completed',
                'cancelled': 'cancelled'
            }[status] || 'pending';

            // حالة إرسال واتساب
            const whatsappSent = order.whatsappSent ? 
                '<span style="color: #4cd964; font-size: 12px; margin-right: 5px;"><i class="fab fa-whatsapp"></i> تم الإرسال</span>' : 
                '<span style="color: #ffcc00; font-size: 12px; margin-right: 5px;"><i class="fab fa-whatsapp"></i> لم يرسل</span>';

            ordersHTML += `
                <div class="order-item">
                    <div class="checkbox-group">
                        <input type="checkbox" id="order-${order.id}" onchange="toggleOrderSelection('${order.id}')">
                        <label for="order-${order.id}">تحديد</label>
                    </div>
                    <div class="order-info">
                        <h4>${orderNumber} ${whatsappSent}</h4>
                        <p>العميل: ${customerName}</p>
                        <div class="order-details">
                            <span><i class="fas fa-calendar"></i> ${orderDate}</span>
                            <span><i class="fas fa-money-bill"></i> ${orderTotal.toFixed(2)} جنيه</span>
                            <span><i class="fas fa-box"></i> ${order.items ? order.items.length : 0} منتج</span>
                        </div>
                    </div>
                    <div class="order-status status-${statusClass}">
                        ${statusText}
                    </div>
                    <div class="action-buttons">
                        <button onclick="viewOrderDetails('${order.id}')" class="btn-edit">
                            <i class="fas fa-eye"></i> تفاصيل
                        </button>
                        <button onclick="manageOrderPayments('${order.id}')" class="btn-edit">
                            <i class="fas fa-money-bill-wave"></i>
                            المدفوعات
                        </button>
                        <button onclick="showDeleteConfirmation('${order.id}', 'order', 'طلب')" class="btn-delete">
                            <i class="fas fa-trash"></i> حذف
                        </button>
                    </div>
                </div>
            `;
        });

        ordersList.innerHTML = ordersHTML;
    }

    // مسح البحث
    window.clearSearch = () => {
        document.getElementById("searchByName").value = "";
        document.getElementById("searchByOrderNumber").value = "";
        document.getElementById("searchByPhone").value = "";
        document.getElementById("searchByStatus").value = "";
        
        document.getElementById("searchResultsInfo").style.display = "none";
        searchActive = false;
        
        displayAllOrders();
        showNotification("معلومات", "تم مسح البحث وعرض جميع الطلبات", "info");
    };

    // ========== إدارة المنتجات ==========

    // تحميل المنتجات من Firebase
    async function loadProducts() {
        const productsList = document.getElementById("productsList");
        
        try {
            productsList.innerHTML = '<div class="empty-state"><div class="loading"></div><h3>جاري تحميل المنتجات...</h3></div>';
            
            if (!db) {
                throw new Error("Firebase غير مهيأ");
            }
            
            const querySnapshot = await db.collection("products")
                .orderBy("createdAt", "desc")
                .get();
            
            allProducts = [];
            let productsCount = 0;
            let totalSalesValue = 0;

            if (querySnapshot.empty) {
                productsList.innerHTML = `
                    <div class="empty-state" style="grid-column: 1 / -1;">
                        <i class="fas fa-box-open"></i>
                        <h3>لا توجد منتجات</h3>
                        <p>لم يتم إضافة أي منتجات بعد. ابدأ بإضافة منتج جديد.</p>
                    </div>
                `;
            } else {
                let productsHTML = "";
                
                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    
                    let imageUrl = data.imageURL || data.image || data.imagulBL || DEFAULT_IMAGE;
                    
                    const product = {
                        id: doc.id,
                        name: data.name || "منتج بدون اسم",
                        category: data.category || "أخرى",
                        price: parseFloat(data.price) || 0,
                        quantity: parseInt(data.quantity) || 0,
                        description: data.description || "لا يوجد وصف",
                        image: imageUrl,
                        inStock: (parseInt(data.quantity) || 0) > 0,
                        imgbbData: data.imgbbData,
                        createdAt: data.createdAt || new Date()
                    };
                    
                    allProducts.push(product);
                    productsCount++;
                    totalSalesValue += (product.price || 0) * (product.quantity || 0);

                    productsHTML += `
                        <div class="product">
                            <div class="checkbox-group">
                                <input type="checkbox" id="product-${product.id}" onchange="toggleProductSelection('${product.id}')">
                                <label for="product-${product.id}">تحديد للحذف</label>
                            </div>
                            <img src="${product.image}" class="product-img" alt="${product.name}" 
                                 onerror="this.src='${DEFAULT_IMAGE}'">
                            <div class="product-info">
                                <div class="product-name">${product.name}</div>
                                <div class="product-category">${product.category}</div>
                                <p style="color: #ccc; font-size: 14px; margin: 5px 0;">${product.description}</p>
                                <div class="product-details">
                                    <div class="product-price">${product.price.toFixed(2)} جنيه</div>
                                    <div class="product-quantity">
                                        <i class="fas fa-cubes"></i> ${product.quantity}
                                    </div>
                                </div>
                                <div class="action-buttons">
                                    <button onclick="editProduct('${product.id}')" class="btn-edit">
                                        <i class="fas fa-edit"></i> تعديل
                                    </button>
                                    <button onclick="showDeleteConfirmation('${product.id}', 'product', 'منتج')" class="btn-delete">
                                        <i class="fas fa-trash"></i> حذف
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                });
                
                productsList.innerHTML = productsHTML;
            }

            // تحديث الإحصائيات
            const totalProductsElement = document.getElementById("totalProducts");
            const totalSalesElement = document.getElementById("totalSales");
            
            if (totalProductsElement) totalProductsElement.textContent = productsCount;
            if (totalSalesElement) totalSalesElement.textContent = `${totalSalesValue.toFixed(2)} جنيه`;
            
            console.log(`✅ تم تحميل ${productsCount} منتج(ات) من Firebase`);
            
            // تحديث نظام الكاشير إذا كان مفتوحاً
            if (document.getElementById("cashierPage").style.display !== "none") {
                loadCashierProducts();
                updateCashierStats();
            }
            
        } catch (error) {
            console.error("❌ خطأ في تحميل المنتجات من Firebase:", error);
            productsList.innerHTML = `
                <div class="empty-state" style="grid-column: 1 / -1;">
                    <i class="fas fa-exclamation-triangle"></i>
                    <h3>خطأ في تحميل المنتجات</h3>
                    <p>${error.message}</p>
                    <button onclick="loadProducts()" style="margin-top: 15px; padding: 10px 20px; background: #00c6ff; color: #000; border: none; border-radius: 8px; cursor: pointer;">
                        <i class="fas fa-redo"></i> إعادة المحاولة
                    </button>
                </div>
            `;
            showNotification("خطأ", "فشل في تحميل المنتجات من قاعدة البيانات", "error");
        }
    }

    // دالة التحقق من كمية المنتج
    window.validateProductQuantity = () => {
        const quantityInput = document.getElementById("quantity");
        const quantity = parseInt(quantityInput.value);
        
        if (quantity > 1000) {
            showNotification("معلومات", "يمكنك إضافة حتى 1000 قطعة في المخزون", "info");
        }
    };

    // إضافة منتج جديد
    async function addProduct() {
        console.log("بدء إضافة منتج...");
        
        const name = document.getElementById("name").value.trim();
        const category = document.getElementById("category").value.trim();
        const price = parseFloat(document.getElementById("price").value);
        const quantity = parseInt(document.getElementById("quantity").value);
        const description = document.getElementById("description").value.trim();
        const fileInput = document.getElementById("image");
        const file = fileInput.files[0];
        
        console.log("بيانات المنتج:", { name, category, price, quantity, description });

        // التحقق من المدخلات
        if (!name) {
            showNotification("تحذير", "يرجى إدخال اسم المنتج", "warning");
            document.getElementById("name").focus();
            return;
        }

        if (!category) {
            showNotification("تحذير", "يرجى إدخال نوع المنتج", "warning");
            document.getElementById("category").focus();
            return;
        }

        if (!price || isNaN(price) || price <= 0) {
            showNotification("تحذير", "يرجى إدخال سعر صحيح أكبر من الصفر", "warning");
            document.getElementById("price").focus();
            return;
        }

        if (!quantity || isNaN(quantity) || quantity < 0) {
            showNotification("تحذير", "يرجى إدخال كمية صحيحة", "warning");
            document.getElementById("quantity").focus();
            return;
        }

        // تغيير نص الزر لإظهار التحميل
        const addProductBtn = document.getElementById("addProductBtn");
        const originalText = addProductBtn.innerHTML;
        addProductBtn.innerHTML = '<div class="loading"></div> جاري الإضافة...';
        addProductBtn.disabled = true;

        try {
            let imageURL = DEFAULT_IMAGE;
            let imgbbData = null;
            
            // إذا تم تحميل صورة، قم برفعها إلى IMGBB
            if (file) {
                showNotification("معلومات", "جاري رفع الصورة إلى IMGBB...", "info");
                
                try {
                    imgbbData = await uploadImageToImgBB(file);
                    imageURL = imgbbData.url;
                    console.log("✅ تم رفع الصورة بنجاح:", imageURL);
                } catch (uploadError) {
                    console.warn("⚠️ استخدام الصورة الافتراضية بسبب خطأ في الرفع:", uploadError);
                    showNotification("تنبيه", "تم استخدام صورة افتراضية بسبب خطأ في رفع الصورة", "warning");
                }
            }

            // بيانات المنتج
            const productData = {
                name,
                category,
                price: parseFloat(price.toFixed(2)),
                quantity: parseInt(quantity),
                description: description || "لا يوجد وصف",
                imageURL: imageURL,
                imgbbData: imgbbData,
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            };

            // إضافة المنتج إلى Firestore
            const docRef = await db.collection("products").add(productData);
            console.log("✅ تم إضافة المنتج بنجاح مع ID:", docRef.id);

            // إعادة تعيين النموذج
            resetProductForm();

            // إعادة تحميل المنتجات وعرض إشعار النجاح
            showNotification("نجاح", "تم إضافة المنتج بنجاح!", "success");
            loadProducts();
            
        } catch (error) {
            console.error("❌ خطأ في إضافة المنتج:", error);
            showNotification("خطأ", `فشل في إضافة المنتج: ${error.message}`, "error");
        } finally {
            // استعادة نص الزر الأصلي
            addProductBtn.innerHTML = originalText;
            addProductBtn.disabled = false;
        }
    }

    // دالة إعادة تعيين نموذج المنتج
    function resetProductForm() {
        document.getElementById("name").value = "";
        document.getElementById("category").value = "";
        document.getElementById("price").value = "";
        document.getElementById("quantity").value = "";
        document.getElementById("description").value = "";
        document.getElementById("image").value = "";
        document.getElementById("file-name").textContent = "اختر صورة للمنتج (اختياري)";
        document.getElementById("editProductId").value = "";
        document.getElementById("imagePreview").innerHTML = "";
        
        // إعادة النموذج إلى وضع الإضافة
        const formTitle = document.getElementById("formTitle");
        const addProductBtn = document.getElementById("addProductBtn");
        const updateProductBtn = document.getElementById("updateProductBtn");
        const cancelEditBtn = document.getElementById("cancelEditBtn");
        
        if (formTitle) formTitle.innerHTML = '<i class="fas fa-plus-circle"></i> إضافة منتج جديد';
        if (addProductBtn) addProductBtn.style.display = "flex";
        if (updateProductBtn) updateProductBtn.style.display = "none";
        if (cancelEditBtn) cancelEditBtn.style.display = "none";
    }

    // تعديل منتج
    window.editProduct = async (productId) => {
        try {
            const doc = await db.collection("products").doc(productId).get();
            
            if (!doc.exists) {
                showNotification("خطأ", "المنتج غير موجود", "error");
                return;
            }

            const product = doc.data();

            // تعبئة النموذج ببيانات المنتج
            document.getElementById("name").value = product.name || "";
            document.getElementById("category").value = product.category || "";
            document.getElementById("price").value = product.price || "";
            document.getElementById("quantity").value = product.quantity || "";
            document.getElementById("description").value = product.description || "";
            document.getElementById("editProductId").value = productId;
            
            // عرض معلومات الصورة الحالية
            const imagePreview = document.getElementById("imagePreview");
            if (imagePreview && product.imageURL) {
                imagePreview.innerHTML = `
                    <p style="color: #4cd964; margin-bottom: 10px;">
                        <i class="fas fa-image"></i> الصورة الحالية:
                    </p>
                    <img src="${product.imageURL}" style="max-width: 200px; max-height: 150px; border-radius: 10px; border: 2px solid rgba(0, 198, 255, 0.3);">
                `;
            }
            
            // تغيير النموذج إلى وضع التعديل
            const formTitle = document.getElementById("formTitle");
            const addProductBtn = document.getElementById("addProductBtn");
            const updateProductBtn = document.getElementById("updateProductBtn");
            const cancelEditBtn = document.getElementById("cancelEditBtn");
            
            if (formTitle) formTitle.innerHTML = '<i class="fas fa-edit"></i> تعديل المنتج';
            if (addProductBtn) addProductBtn.style.display = "none";
            if (updateProductBtn) updateProductBtn.style.display = "flex";
            if (cancelEditBtn) cancelEditBtn.style.display = "flex";
            
            showNotification("معلومات", "يمكنك الآن تعديل بيانات المنتج", "info");
            
        } catch (error) {
            console.error("خطأ في تحميل المنتج للتعديل:", error);
            showNotification("خطأ", "فشل في تحميل بيانات المنتج", "error");
        }
    };

    // تحديث منتج
    window.updateProduct = async () => {
        const productId = document.getElementById("editProductId").value;
        const name = document.getElementById("name").value.trim();
        const category = document.getElementById("category").value.trim();
        const price = parseFloat(document.getElementById("price").value);
        const quantity = parseInt(document.getElementById("quantity").value);
        const description = document.getElementById("description").value.trim();
        const fileInput = document.getElementById("image");
        const file = fileInput.files[0];

        // التحقق من المدخلات
        if (!name || !category || !price || price <= 0 || !quantity || quantity < 0) {
            showNotification("تحذير", "يرجى ملء جميع الحقول المطلوبة بشكل صحيح", "warning");
            return;
        }

        // تغيير نص الزر لإظهار التحميل
        const updateProductBtn = document.getElementById("updateProductBtn");
        const originalText = updateProductBtn.innerHTML;
        updateProductBtn.innerHTML = '<div class="loading"></div> جاري التحديث...';
        updateProductBtn.disabled = true;

        try {
            const productDoc = await db.collection("products").doc(productId).get();
            if (!productDoc.exists) {
                throw new Error("المنتج غير موجود");
            }
            
            const currentProduct = productDoc.data();
            
            let updateData = {
                name,
                category,
                price: parseFloat(price.toFixed(2)),
                quantity: parseInt(quantity),
                description: description || "لا يوجد وصف",
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            };

            // إذا تم تحميل صورة جديدة، قم برفعها
            if (file) {
                showNotification("معلومات", "جاري رفع الصورة الجديدة إلى IMGBB...", "info");
                
                try {
                    const imgbbData = await uploadImageToImgBB(file);
                    updateData.imageURL = imgbbData.url;
                    updateData.imgbbData = imgbbData;
                    console.log("✅ تم رفع الصورة الجديدة بنجاح");
                } catch (uploadError) {
                    console.warn("⚠️ الاحتفاظ بالصورة القديمة:", uploadError);
                    showNotification("تنبيه", "تم الاحتفاظ بالصورة القديمة", "warning");
                    updateData.imageURL = currentProduct.imageURL;
                    updateData.imgbbData = currentProduct.imgbbData;
                }
            } else {
                updateData.imageURL = currentProduct.imageURL;
                updateData.imgbbData = currentProduct.imgbbData;
            }

            // تحديث المنتج في Firebase
            await db.collection("products").doc(productId).update(updateData);

            resetProductForm();
            showNotification("نجاح", "تم تحديث المنتج بنجاح", "success");
            loadProducts();
            
        } catch (error) {
            console.error("خطأ في تحديث المنتج:", error);
            showNotification("خطأ", `فشل في تحديث المنتج: ${error.message}`, "error");
        } finally {
            updateProductBtn.innerHTML = originalText;
            updateProductBtn.disabled = false;
        }
    };

    // إلغاء التعديل
    window.cancelEdit = () => {
        resetProductForm();
        showNotification("معلومات", "تم إلغاء التعديل", "info");
    };

    // تحديث قائمة المنتجات
    window.refreshProducts = () => {
        loadProducts();
        showNotification("معلومات", "جاري تحديث قائمة المنتجات...", "info");
    };

    // ========== إدارة الطلبات ==========

    // تحميل الطلبات من Firebase
    async function loadOrders() {
        const ordersList = document.getElementById("ordersList");
        if (!ordersList) return;
        
        try {
            ordersList.innerHTML = '<div class="empty-state"><div class="loading"></div><h3>جاري تحميل الطلبات...</h3></div>';
            
            // جلب الطلبات من Firestore
            const querySnapshot = await db.collection("orders")
                .orderBy("createdAt", "desc")
                .get();
            
            allOrders = [];
            let ordersCount = 0;
            let pendingOrders = 0;
            let completedOrders = 0;
            let cancelledOrders = 0;
            let totalSalesValue = 0;

            if (querySnapshot.empty) {
                ordersList.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-shopping-cart"></i>
                        <h3>لا توجد طلبات</h3>
                        <p>لم يتم إضافة أي طلبات بعد.</p>
                    </div>
                `;
            } else {
                querySnapshot.forEach((doc) => {
                    const order = {
                        id: doc.id,
                        ...doc.data()
                    };
                    allOrders.push(order);
                    ordersCount++;

                    // حساب إجمالي قيمة الطلب
                    let orderTotal = 0;
                    if (order.summary && order.summary.total) {
                        orderTotal = order.summary.total;
                    } else if (order.payment && order.payment.total) {
                        orderTotal = order.payment.total;
                    } else if (order.total) {
                        orderTotal = order.total;
                    }
                    totalSalesValue += orderTotal;

                    // حساب إحصائيات الحالة
                    const status = order.status || 'pending';
                    if (status === 'pending') pendingOrders++;
                    else if (status === 'completed' || status === 'delivered') completedOrders++;
                    else if (status === 'cancelled') cancelledOrders++;
                });

                // عرض جميع الطلبات
                displayAllOrders();
                
                // تحديث إحصائيات الطلبات
                updateOrdersStats(ordersCount, pendingOrders, completedOrders, cancelledOrders, totalSalesValue);
            }

            // تحديث الإحصائيات الرئيسية
            const totalOrdersElement = document.getElementById("totalOrders");
            const totalSalesElement = document.getElementById("totalSales");
            
            if (totalOrdersElement) totalOrdersElement.textContent = ordersCount;
            if (totalSalesElement) totalSalesElement.textContent = `${totalSalesValue.toFixed(2)} جنيه`;
            
        } catch (error) {
            console.error("خطأ في تحميل الطلبات:", error);
            ordersList.innerHTML = `
                <div style="text-align: center; padding: 40px; color: #ff6b6b;">
                    <i class="fas fa-exclamation-circle fa-2x"></i>
                    <h4>خطأ في تحميل الطلبات</h4>
                    <p>${error.message}</p>
                </div>
            `;
        }
    }

    // تحديث إحصائيات الطلبات
    function updateOrdersStats(total, pending, completed, cancelled, sales) {
        const ordersStats = document.getElementById("ordersStats");
        if (ordersStats) {
            ordersStats.innerHTML = `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-top: 15px;">
                    <div style="background: rgba(255, 255, 255, 0.05); padding: 15px; border-radius: 10px;">
                        <div style="font-size: 24px; font-weight: bold; color: #00c6ff;">${total}</div>
                        <div style="color: #aaa;">إجمالي الطلبات</div>
                    </div>
                    <div style="background: rgba(255, 255, 255, 0.05); padding: 15px; border-radius: 10px;">
                        <div style="font-size: 24px; font-weight: bold; color: #ffcc00;">${pending}</div>
                        <div style="color: #aaa;">قيد الانتظار</div>
                    </div>
                    <div style="background: rgba(255, 255, 255, 0.05); padding: 15px; border-radius: 10px;">
                        <div style="font-size: 24px; font-weight: bold; color: #4cd964;">${completed}</div>
                        <div style="color: #aaa;">مكتملة</div>
                    </div>
                    <div style="background: rgba(255, 255, 255, 0.05); padding: 15px; border-radius: 10px;">
                        <div style="font-size: 24px; font-weight: bold; color: #ff3b30;">${cancelled}</div>
                        <div style="color: #aaa;">ملغية</div>
                    </div>
                </div>
                <div style="margin-top: 20px; padding: 15px; background: rgba(255, 255, 255, 0.05); border-radius: 10px;">
                    <div style="font-size: 20px; font-weight: bold; color: #9b59b6;">
                        إجمالي قيمة الطلبات: ${sales.toFixed(2)} جنيه
                    </div>
                </div>
            `;
        }
    }

    // عرض تفاصيل الطلب
    window.viewOrderDetails = async (orderId) => {
        try {
            const doc = await db.collection("orders").doc(orderId).get();
            
            if (!doc.exists) {
                showNotification("خطأ", "الطلب غير موجود", "error");
                return;
            }

            const order = doc.data();
            
            // اسم العميل
            const customerName = order.customer ? 
                (order.customer.name || 'غير محدد') : 
                'غير محدد';
            
            // هاتف العميل
            const customerPhone = order.customer ? 
                (order.customer.phone || 'غير محدد') : 
                'غير محدد';
            
            // تاريخ الطلب
            const orderDate = order.createdAt ? 
                order.createdAt.toDate().toLocaleDateString('ar-EG') + ' ' + 
                order.createdAt.toDate().toLocaleTimeString('ar-EG') : 
                'غير محدد';
            
            // رقم الطلب
            const orderNumber = order.orderNumber || `ORD-${orderId.slice(0, 8)}`;
            
            // طريقة الدفع
            const paymentMethod = order.payment ? 
                (order.payment.method || 'نقداً') : 
                'نقداً';
            
            // حالة الطلب
            const status = order.status || 'pending';
            const statusText = {
                'pending': 'قيد الانتظار',
                'processing': 'قيد المعالجة',
                'shipped': 'تم الشحن',
                'delivered': 'تم التوصيل',
                'completed': 'مكتمل',
                'cancelled': 'ملغي'
            }[status] || status;
            
            // طريقة التوصيل
            const deliveryMethod = order.deliveryMethod || 
                (order.delivery && order.delivery.method) || 
                'استلام من المتجر';
            
            const deliveryMethodText = {
                'delivery': 'توصيل للعميل',
                'pickup': 'استلام من المتجر'
            }[deliveryMethod] || deliveryMethod;
            
            // حساب المدفوعات
            let totalPaid = 0;
            let cashPaid = 0;
            let transferPaid = 0;
            let paymentHistoryHTML = '';
            
            if (order.payments && Array.isArray(order.payments)) {
                order.payments.forEach((payment, index) => {
                    totalPaid += payment.amount || 0;
                    if (payment.method === 'cash') {
                        cashPaid += payment.amount || 0;
                    } else if (payment.method === 'transfer') {
                        transferPaid += payment.amount || 0;
                    }
                    
                    const paymentDate = payment.date ? 
                        (payment.date.toDate ? payment.date.toDate().toLocaleDateString('ar-EG') : 
                        new Date(payment.date).toLocaleDateString('ar-EG')) : 
                        'غير محدد';
                    
                    const paymentTime = payment.date ? 
                        (payment.date.toDate ? payment.date.toDate().toLocaleTimeString('ar-EG') : 
                        new Date(payment.date).toLocaleTimeString('ar-EG')) : 
                        'غير محدد';
                    
                    paymentHistoryHTML += `
                        <div class="payment-item">
                            <div>
                                <span class="payment-method-badge ${payment.method === 'cash' ? 'badge-cash' : 'badge-transfer'}">
                                    ${payment.method === 'cash' ? 'نقداً' : 'تحويل'}
                                </span>
                                <span style="margin-right: 10px;">${paymentDate}</span>
                                <span style="color: #aaa; font-size: 12px;">${paymentTime}</span>
                            </div>
                            <div>
                                <strong style="color: #4cd964;">${(payment.amount || 0).toFixed(2)} ج.م</strong>
                            </div>
                        </div>
                    `;
                });
            } else {
                // إذا لم توجد مدفوعات كصفيف، استخدم الدفع الحالي
                totalPaid = order.payment?.amount || 0;
                if (order.payment?.method === 'cash') cashPaid = totalPaid;
                else if (order.payment?.method === 'transfer') transferPaid = totalPaid;
            }
            
            // العناصر
            let itemsHTML = '';
            if (order.items && Array.isArray(order.items)) {
                order.items.forEach((item, index) => {
                    const itemName = item.name || 'منتج بدون اسم';
                    const itemPrice = item.price || 0;
                    const itemQuantity = item.quantity || 1;
                    const itemTotal = itemPrice * itemQuantity;
                    
                    itemsHTML += `
                        <div class="order-item-row">
                            <div>${itemName}</div>
                            <div>${itemPrice.toFixed(2)} جنيه</div>
                            <div>${itemQuantity}</div>
                            <div>${itemTotal.toFixed(2)} جنيه</div>
                        </div>
                    `;
                });
            }
            
            // الإجماليات
            const subtotal = order.summary ? (order.summary.subtotal || 0) : 0;
            const shipping = order.summary ? (order.summary.shipping || 0) : 0;
            const discount = order.summary ? (order.summary.discount || 0) : 0;
            const total = order.summary ? (order.summary.total || subtotal + shipping - discount) : (subtotal + shipping - discount);
            
            // حساب المتبقي
            const remaining = total - totalPaid;
            const paymentStatus = calculatePaymentStatus(totalPaid, total);
            const progressPercentage = Math.min((totalPaid / total) * 100, 100);
            
            // سجل المدفوعات
            let paymentHistorySection = '';
            if (paymentHistoryHTML) {
                paymentHistorySection = `
                    <div class="payment-history-container" style="margin: 20px 0;">
                        <h4 style="margin-bottom: 10px; color: #00c6ff;">سجل المدفوعات</h4>
                        ${paymentHistoryHTML}
                    </div>
                `;
            }
            
            // صورة إثبات الدفع
            let paymentProofHTML = '';
            if (order.payment && order.payment.proofUrl) {
                const proofUrl = order.payment.proofUrl;
                paymentProofHTML = `
                    <div style="margin-top: 15px;">
                        <h4 style="color: #00c6ff; margin-bottom: 10px;">صورة إثبات الدفع</h4>
                        <img src="${proofUrl}" 
                             class="payment-proof-image" 
                             alt="صورة إثبات الدفع"
                             onclick="viewPaymentProof('${proofUrl}')"
                             style="cursor: pointer;">
                        ${order.payment.proofData ? `
                            <div class="imgbb-info">
                                <i class="fas fa-info-circle"></i> 
                                الصورة مخزنة في IMGBB - 
                                <a href="${order.payment.proofData.deleteUrl}" target="_blank" style="color: #4cd964;">رابط الحذف</a>
                            </div>
                        ` : ''}
                    </div>
                `;
            }
            
            // معلومات الدفع
            let paymentDetailsHTML = '';
            if (order.payment) {
                paymentDetailsHTML = `
                    <div class="payment-info">
                        <h4 style="margin-bottom: 10px; color: #00c6ff;">معلومات الدفع</h4>
                        <div class="info-row">
                            <span class="info-label">طريقة الدفع:</span>
                            <span class="info-value">${paymentMethod}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">المبلغ المدفوع:</span>
                            <span class="info-value">${totalPaid.toFixed(2)} جنيه</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">المبلغ المتبقي:</span>
                            <span class="info-value">${remaining.toFixed(2)} جنيه</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">حالة الدفع:</span>
                            <span class="info-value">${paymentStatus}</span>
                        </div>
                    </div>
                `;
            }
            
            // حالة إرسال واتساب
            let whatsappInfoHTML = '';
            if (order.whatsappSent) {
                const whatsappSentDate = order.whatsappSentAt ? 
                    order.whatsappSentAt.toDate().toLocaleString('ar-EG') : 
                    'غير محدد';
                
                whatsappInfoHTML = `
                    <div class="whatsapp-info">
                        <h4><i class="fab fa-whatsapp"></i> حالة إرسال واتساب</h4>
                        <div class="info-row">
                            <span class="info-label">تم الإرسال:</span>
                            <span class="info-value" style="color: #4cd964;">نعم</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">وقت الإرسال:</span>
                            <span class="info-value">${whatsappSentDate}</span>
                        </div>
                    </div>
                `;
            }
            
            // عنوان التوصيل
            let deliveryAddressHTML = '';
            if (order.delivery && order.delivery.address) {
                deliveryAddressHTML = `
                    <div class="customer-info">
                        <h4 style="margin-bottom: 10px; color: #00c6ff;">عنوان التوصيل</h4>
                        <div class="info-row">
                            <span class="info-label">العنوان:</span>
                            <span class="info-value">${order.delivery.address}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">تكلفة الشحن:</span>
                            <span class="info-value">${(order.delivery.cost || 0).toFixed(2)} جنيه</span>
                        </div>
                    </div>
                `;
            }
            
            // إنشاء HTML لعرض التفاصيل
            const detailsHTML = `
                <div class="customer-info">
                    <h4 style="margin-bottom: 10px; color: #00c6ff;">معلومات العميل</h4>
                    <div class="info-row">
                        <span class="info-label">الاسم:</span>
                        <span class="info-value">${customerName}</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">الهاتف:</span>
                        <span class="info-value">
                            ${customerPhone}
                            <button onclick="changeOrderStatus('${orderId}')" 
                                    class="whatsapp-btn small" style="margin-right: 10px;">
                                <i class="fab fa-whatsapp"></i> تحديث العميل
                            </button>
                        </span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">طريقة التوصيل:</span>
                        <span class="info-value">${deliveryMethodText}</span>
                    </div>
                </div>
                
                ${deliveryAddressHTML}
                
                ${whatsappInfoHTML}
                
                <div class="payment-info">
                    <h4 style="margin-bottom: 10px; color: #00c6ff;">معلومات الطلب</h4>
                    <div class="info-row">
                        <span class="info-label">رقم الطلب:</span>
                        <span class="info-value">${orderNumber}</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">تاريخ الطلب:</span>
                        <span class="info-value">${orderDate}</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">حالة الطلب:</span>
                        <span class="info-value">${statusText}</span>
                    </div>
                </div>
                
                <div class="payment-tracker">
                    <h4 style="margin-bottom: 10px; color: #00c6ff;">تتبع المدفوعات</h4>
                    
                    <div class="payment-progress">
                        <div class="payment-progress-bar" style="width: ${progressPercentage}%"></div>
                    </div>
                    
                    <div style="display: flex; justify-content: space-between; font-size: 14px; color: #aaa;">
                        <span>المدفوع: ${totalPaid.toFixed(2)} ج.م</span>
                        <span>الإجمالي: ${total.toFixed(2)} ج.م</span>
                    </div>
                    
                    <div style="text-align: center; margin-top: 10px;">
                        <span class="payment-method-badge ${paymentStatus === 'paid' ? 'badge-cash' : paymentStatus === 'partial' ? 'badge-transfer' : ''}">
                            ${paymentStatus === 'paid' ? 'مدفوع بالكامل' : paymentStatus === 'partial' ? 'مدفوع جزئياً' : 'غير مدفوع'}
                        </span>
                    </div>
                </div>
                
                <div class="payment-summary-grid">
                    <div class="payment-summary-card">
                        <div style="color: #aaa; font-size: 14px;">النقدي</div>
                        <div class="payment-summary-value payment-summary-cash">
                            ${cashPaid.toFixed(2)} ج.م
                        </div>
                    </div>
                    
                    <div class="payment-summary-card">
                        <div style="color: #aaa; font-size: 14px;">التحويل</div>
                        <div class="payment-summary-value payment-summary-transfer">
                            ${transferPaid.toFixed(2)} ج.م
                        </div>
                    </div>
                    
                    <div class="payment-summary-card">
                        <div style="color: #aaa; font-size: 14px;">المجموع</div>
                        <div class="payment-summary-value payment-summary-total">
                            ${totalPaid.toFixed(2)} ج.م
                        </div>
                    </div>
                </div>
                
                ${remaining > 0 ? `
                <div class="remaining-amount">
                    <h4><i class="fas fa-exclamation-circle"></i> المبلغ المتبقي</h4>
                    <div class="remaining-amount-value">${remaining.toFixed(2)} ج.م</div>
                    <p style="color: #aaa; margin-top: 10px; font-size: 14px;">
                        العميل لم يدفع هذا المبلغ بعد
                    </p>
                </div>
                ` : `
                <div class="remaining-amount" style="border-color: rgba(76, 217, 100, 0.3); background: rgba(76, 217, 100, 0.1);">
                    <h4 style="color: #4cd964;"><i class="fas fa-check-circle"></i> لا يوجد مبلغ متبقي</h4>
                    <div class="remaining-amount-value" style="color: #4cd964;">0.00 ج.م</div>
                    <p style="color: #4cd964; margin-top: 10px; font-size: 14px;">
                        تم دفع الطلب بالكامل
                    </p>
                </div>
                `}
                
                ${paymentHistorySection}
                
                <h4 style="margin: 20px 0 10px 0; color: #00c6ff;">المنتجات المطلوبة</h4>
                <div class="order-items-list">
                    <div class="order-item-row header">
                        <div>المنتج</div>
                        <div>السعر</div>
                        <div>الكمية</div>
                        <div>الإجمالي</div>
                    </div>
                    ${itemsHTML || '<div style="padding: 20px; text-align: center; color: #aaa;">لا توجد منتجات</div>'}
                </div>
                
                <div class="summary-info">
                    <h4 style="margin-bottom: 10px; color: #00c6ff;">الإجماليات</h4>
                    <div class="info-row">
                        <span class="info-label">المجموع الفرعي:</span>
                        <span class="info-value">${subtotal.toFixed(2)} جنيه</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">الخصم:</span>
                        <span class="info-value">-${discount.toFixed(2)} جنيه</span>
                    </div>
                    ${shipping > 0 ? `
                    <div class="info-row">
                        <span class="info-label">مصاريف الشحن:</span>
                        <span class="info-value">${shipping.toFixed(2)} جنيه</span>
                    </div>
                    ` : ''}
                    <div class="info-row">
                        <span class="info-label">الإجمالي:</span>
                        <span class="info-value" style="color: #4cd964; font-size: 18px;">${total.toFixed(2)} جنيه</span>
                    </div>
                    <div class="info-row" style="background: rgba(0, 198, 255, 0.1); padding: 10px; border-radius: 8px;">
                        <span class="info-label">المبلغ المدفوع:</span>
                        <span class="info-value" style="color: #ffcc00; font-weight: bold;">${totalPaid.toFixed(2)} جنيه</span>
                    </div>
                    ${remaining > 0 ? `
                    <div class="info-row" style="background: rgba(255, 107, 107, 0.1); padding: 10px; border-radius: 8px;">
                        <span class="info-label">المبلغ المتبقي:</span>
                        <span class="info-value" style="color: #ff6b6b; font-weight: bold;">${remaining.toFixed(2)} جنيه</span>
                    </div>
                    ` : ''}
                </div>
                
                ${paymentProofHTML}
                
                <div class="payment-actions" style="margin-top: 20px;">
                    <button class="payment-btn payment-btn-cash" onclick="addNewPayment('${orderId}', 'cash')">
                        <i class="fas fa-money-bill-wave"></i>
                        إضافة دفعة نقدية
                    </button>
                    <button class="payment-btn payment-btn-transfer" onclick="addNewPayment('${orderId}', 'transfer')">
                        <i class="fas fa-university"></i>
                        إضافة دفعة تحويل
                    </button>
                    <button class="whatsapp-btn" onclick="sendOrderInvoiceViaWhatsApp('${orderId}')">
                        <i class="fab fa-whatsapp"></i>
                        إرسال الفاتورة
                    </button>
                </div>
            `;
            
            // عرض النافذة
            document.getElementById("orderDetailsContent").innerHTML = detailsHTML;
            document.getElementById("orderDetailsModal").classList.add("active");
            
        } catch (error) {
            console.error("خطأ في عرض تفاصيل الطلب:", error);
            showNotification("خطأ", `فشل في عرض تفاصيل الطلب: ${error.message}`, "error");
        }
    };

    // إدارة مدفوعات الطلب
    window.manageOrderPayments = async (orderId) => {
        try {
            const doc = await db.collection("orders").doc(orderId).get();
            
            if (!doc.exists) {
                showNotification("خطأ", "الطلب غير موجود", "error");
                return;
            }

            const order = doc.data();
            const orderNumber = order.orderNumber || `ORD-${orderId.slice(0, 8)}`;
            const customerName = order.customer?.name || 'غير محدد';
            
            // حساب إجمالي الطلب
            const total = order.summary?.total || order.total || 0;
            
            // حساب المدفوعات السابقة
            let allPayments = order.payments || [];
            let totalPaid = 0;
            let cashPaid = 0;
            let transferPaid = 0;
            
            // حساب تفصيلي للمدفوعات
            allPayments.forEach(payment => {
                totalPaid += payment.amount || 0;
                if (payment.method === 'cash') {
                    cashPaid += payment.amount || 0;
                } else if (payment.method === 'transfer') {
                    transferPaid += payment.amount || 0;
                }
            });
            
            // حساب المتبقي
            const remaining = total - totalPaid;
            const paymentStatus = calculatePaymentStatus(totalPaid, total);
            const progressPercentage = Math.min((totalPaid / total) * 100, 100);
            
            // إنشاء HTML لعرض إدارة المدفوعات
            const manageHTML = `
                <div class="payment-summary">
                    <h4 style="margin-bottom: 10px; color: #00c6ff;">ملخص الطلب</h4>
                    <div class="info-row">
                        <span class="info-label">رقم الطلب:</span>
                        <span class="info-value">${orderNumber}</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">العميل:</span>
                        <span class="info-value">${customerName}</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">إجمالي الطلب:</span>
                        <span class="info-value">${total.toFixed(2)} ج.م</span>
                    </div>
                    <div class="info-row" style="background: rgba(255, 204, 0, 0.1); padding: 10px; border-radius: 8px; margin-top: 10px;">
                        <span class="info-label">المبلغ المدفوع:</span>
                        <span class="info-value" style="color: #ffcc00; font-weight: bold;">${totalPaid.toFixed(2)} ج.م</span>
                    </div>
                    ${remaining > 0 ? `
                    <div class="info-row" style="background: rgba(255, 107, 107, 0.1); padding: 10px; border-radius: 8px;">
                        <span class="info-label">المبلغ المتبقي:</span>
                        <span class="info-value" style="color: #ff6b6b; font-weight: bold;">${remaining.toFixed(2)} ج.م</span>
                    </div>
                    ` : `
                    <div class="info-row" style="background: rgba(76, 217, 100, 0.1); padding: 10px; border-radius: 8px;">
                        <span class="info-label">المبلغ المتبقي:</span>
                        <span class="info-value" style="color: #4cd964; font-weight: bold;">0.00 ج.م (مدفوع بالكامل)</span>
                    </div>
                    `}
                </div>
                
                <div class="payment-tracker">
                    <h4 style="margin-bottom: 10px; color: #00c6ff;">تتبع المدفوعات</h4>
                    
                    <div class="payment-progress">
                        <div class="payment-progress-bar" style="width: ${progressPercentage}%"></div>
                    </div>
                    
                    <div style="display: flex; justify-content: space-between; font-size: 14px; color: #aaa;">
                        <span>المدفوع: ${totalPaid.toFixed(2)} ج.م</span>
                        <span>الإجمالي: ${total.toFixed(2)} ج.م</span>
                    </div>
                    
                    <div style="text-align: center; margin-top: 10px;">
                        <span class="payment-method-badge ${paymentStatus === 'paid' ? 'badge-cash' : paymentStatus === 'partial' ? 'badge-transfer' : ''}">
                            ${paymentStatus === 'paid' ? 'مدفوع بالكامل' : paymentStatus === 'partial' ? 'مدفوع جزئياً' : 'غير مدفوع'}
                        </span>
                    </div>
                </div>
                
                <div class="payment-summary-grid">
                    <div class="payment-summary-card">
                        <div style="color: #aaa; font-size: 14px;">النقدي</div>
                        <div class="payment-summary-value payment-summary-cash">
                            ${cashPaid.toFixed(2)} ج.م
                        </div>
                        <div style="color: #aaa; font-size: 12px;">${allPayments.filter(p => p.method === 'cash').length} دفعة</div>
                    </div>
                    
                    <div class="payment-summary-card">
                        <div style="color: #aaa; font-size: 14px;">التحويل</div>
                        <div class="payment-summary-value payment-summary-transfer">
                            ${transferPaid.toFixed(2)} ج.م
                        </div>
                        <div style="color: #aaa; font-size: 12px;">${allPayments.filter(p => p.method === 'transfer').length} دفعة</div>
                    </div>
                    
                    <div class="payment-summary-card">
                        <div style="color: #aaa; font-size: 14px;">المجموع</div>
                        <div class="payment-summary-value payment-summary-total">
                            ${totalPaid.toFixed(2)} ج.م
                        </div>
                        <div style="color: #aaa; font-size: 12px;">إجمالي المدفوعات</div>
                    </div>
                </div>
                
                <div class="payment-history-container" style="margin: 20px 0;">
                    <h4 style="margin-bottom: 10px; color: #00c6ff;">سجل المدفوعات</h4>
                    
                    ${allPayments.length > 0 ? 
                        allPayments.map((payment, index) => {
                            const paymentDate = payment.date ? 
                                (payment.date.toDate ? payment.date.toDate().toLocaleDateString('ar-EG') : 
                                new Date(payment.date).toLocaleDateString('ar-EG')) : 
                                'غير محدد';
                            
                            const paymentTime = payment.date ? 
                                (payment.date.toDate ? payment.date.toDate().toLocaleTimeString('ar-EG') : 
                                new Date(payment.date).toLocaleTimeString('ar-EG')) : 
                                'غير محدد';
                            
                            return `
                                <div class="payment-item">
                                    <div>
                                        <span class="payment-method-badge ${payment.method === 'cash' ? 'badge-cash' : 'badge-transfer'}">
                                            ${payment.method === 'cash' ? 'نقداً' : 'تحويل'}
                                        </span>
                                        <span style="margin-right: 10px;">${paymentDate}</span>
                                        <span style="color: #aaa; font-size: 12px;">${paymentTime}</span>
                                    </div>
                                    <div>
                                        <strong style="color: #4cd964;">${payment.amount.toFixed(2)} ج.م</strong>
                                    </div>
                                </div>
                            `;
                        }).join('') 
                        : 
                        '<div style="text-align: center; padding: 20px; color: #aaa;">لا توجد مدفوعات سابقة</div>'
                    }
                </div>
                
                <div class="payment-actions">
                    <button class="payment-btn payment-btn-cash" onclick="addNewPayment('${orderId}', 'cash')">
                        <i class="fas fa-money-bill-wave"></i>
                        إضافة دفعة نقدية
                    </button>
                    <button class="payment-btn payment-btn-transfer" onclick="addNewPayment('${orderId}', 'transfer')">
                        <i class="fas fa-university"></i>
                        إضافة دفعة تحويل
                    </button>
                </div>
                
                <input type="hidden" id="manageOrderId" value="${orderId}">
            `;
            
            document.getElementById("managePaymentsContent").innerHTML = manageHTML;
            document.getElementById("managePaymentsModal").classList.add("active");
            
        } catch (error) {
            console.error("خطأ في تحميل بيانات المدفوعات:", error);
            showNotification("خطأ", "فشل في تحميل بيانات المدفوعات", "error");
        }
    };

    // إغلاق نافذة إدارة المدفوعات
    window.closeManagePaymentsModal = () => {
        document.getElementById("managePaymentsModal").classList.remove("active");
    };

    // إضافة دفعة جديدة
    window.addNewPayment = (orderId, method) => {
        // فتح نافذة إضافة دفعة
        showPaymentEntryModal(orderId, method);
    };

    // نافذة إضافة دفعة جديدة
    function showPaymentEntryModal(orderId, method) {
        const paymentModalHTML = `
            <div class="modal-overlay" id="newPaymentModal">
                <div class="modal">
                    <div class="modal-header">
                        <h3 class="modal-title"><i class="fas fa-plus-circle"></i> إضافة دفعة جديدة</h3>
                        <button class="close-modal" onclick="closeNewPaymentModal()">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    
                    <div class="input-group">
                        <label>مبلغ الدفعة (ج.م)</label>
                        <input type="number" id="paymentAmount" placeholder="أدخل مبلغ الدفعة" min="0" step="0.01">
                    </div>
                    
                    <div class="payment-methods">
                        <div class="payment-method ${method === 'cash' ? 'active' : ''}" onclick="selectPaymentMethodInModal('cash')">
                            <i class="fas fa-money-bill-wave"></i>
                            <div>نقداً</div>
                        </div>
                        <div class="payment-method ${method === 'transfer' ? 'active' : ''}" onclick="selectPaymentMethodInModal('transfer')">
                            <i class="fas fa-university"></i>
                            <div>تحويل بنكي</div>
                        </div>
                    </div>
                    
                    <div class="file-input-container" id="paymentProofContainer" ${method === 'transfer' ? '' : 'style="display: none;"'}>
                        <input type="file" id="paymentProofImage" accept="image/*">
                        <label for="paymentProofImage" class="file-input-label">
                            <i class="fas fa-cloud-upload-alt"></i>
                            <span id="payment-proof-name">اختر صورة إثبات الدفع</span>
                        </label>
                    </div>
                    <div class="image-preview" id="paymentProofPreview"></div>
                    
                    <div class="input-group">
                        <label>ملاحظات (اختياري)</label>
                        <textarea id="paymentNotes" rows="3" placeholder="أضف ملاحظات حول الدفعة"></textarea>
                    </div>
                    
                    <input type="hidden" id="paymentOrderId" value="${orderId}">
                    <input type="hidden" id="paymentMethod" value="${method}">
                    
                    <div class="button-group">
                        <button class="btn-update" onclick="saveNewPayment()">
                            <i class="fas fa-save"></i>
                            حفظ الدفعة
                        </button>
                        <button class="btn-cancel" onclick="closeNewPaymentModal()">
                            <i class="fas fa-times"></i>
                            إلغاء
                        </button>
                    </div>
                </div>
            </div>
        `;
        
        // إضافة النافذة إلى body إذا لم تكن موجودة
        if (!document.getElementById("newPaymentModal")) {
            const modalDiv = document.createElement("div");
            modalDiv.innerHTML = paymentModalHTML;
            document.body.appendChild(modalDiv.firstElementChild);
            
            // تعيين أحداث لملف الصورة
            const paymentProofImage = document.getElementById("paymentProofImage");
            const paymentProofName = document.getElementById("payment-proof-name");
            
            if (paymentProofImage && paymentProofName) {
                paymentProofImage.addEventListener("change", function() {
                    if (this.files && this.files[0]) {
                        const file = this.files[0];
                        paymentProofName.textContent = file.name;
                        
                        // عرض معاينة الصورة
                        const reader = new FileReader();
                        reader.onload = function(e) {
                            const preview = document.getElementById("paymentProofPreview");
                            preview.innerHTML = `
                                <p style="color: #4cd964; margin-bottom: 10px;">
                                    <i class="fas fa-image"></i> معاينة الصورة:
                                </p>
                                <img src="${e.target.result}" style="max-width: 200px; max-height: 150px; border-radius: 10px; border: 2px solid rgba(0, 198, 255, 0.3);">
                            `;
                        };
                        reader.readAsDataURL(file);
                    } else {
                        paymentProofName.textContent = "اختر صورة إثبات الدفع";
                        document.getElementById("paymentProofPreview").innerHTML = "";
                    }
                });
            }
        }
        
        document.getElementById("newPaymentModal").classList.add("active");
    }

    // تحديد طريقة الدفع في النافذة
    window.selectPaymentMethodInModal = (method) => {
        document.getElementById("paymentMethod").value = method;
        
        // تحديث التحديد البصري
        document.querySelectorAll('#newPaymentModal .payment-method').forEach(el => {
            el.classList.remove('active');
        });
        event.target.closest('.payment-method').classList.add('active');
        
        // إظهار/إخفاء حقل صورة التحويل
        const paymentProofContainer = document.getElementById("paymentProofContainer");
        if (method === 'transfer') {
            paymentProofContainer.style.display = 'block';
        } else {
            paymentProofContainer.style.display = 'none';
            document.getElementById("paymentProofPreview").innerHTML = "";
        }
    };

    // حفظ دفعة جديدة
    window.saveNewPayment = async () => {
        const orderId = document.getElementById("paymentOrderId").value;
        const amount = parseFloat(document.getElementById("paymentAmount").value);
        const method = document.getElementById("paymentMethod").value;
        const notes = document.getElementById("paymentNotes").value.trim();
        const proofFile = document.getElementById("paymentProofImage")?.files[0];
        
        if (!amount || amount <= 0) {
            showNotification("تحذير", "يرجى إدخال مبلغ صحيح", "warning");
            return;
        }
        
        if (amount <= 0) {
            showNotification("تحذير", "يرجى إدخال مبلغ أكبر من الصفر", "warning");
            return;
        }
        
        try {
            const doc = await db.collection("orders").doc(orderId).get();
            if (!doc.exists) {
                showNotification("خطأ", "الطلب غير موجود", "error");
                return;
            }

            const order = doc.data();
            const total = order.summary?.total || order.total || 0;
            
            // حساب المدفوعات السابقة
            let previousPayments = order.payments || [];
            let totalPaid = 0;
            previousPayments.forEach(p => totalPaid += p.amount || 0);
            
            // التحقق من أن المبلغ الجديد لا يتجاوز الإجمالي
            const newTotalPaid = totalPaid + amount;
            if (newTotalPaid > total) {
                showNotification("تحذير", `المبلغ يتجاوز إجمالي الطلب. المبلغ المسموح به: ${(total - totalPaid).toFixed(2)} ج.م`, "warning");
                return;
            }
            
            // رفع صورة التحويل إذا كانت موجودة
            let proofUrl = null;
            let proofData = null;
            
            if (method === 'transfer' && proofFile) {
                showNotification("معلومات", "جاري رفع صورة الإثبات...", "info");
                try {
                    proofData = await uploadImageToImgBB(proofFile);
                    proofUrl = proofData.url;
                } catch (uploadError) {
                    console.warn("⚠️ خطأ في رفع صورة الإثبات:", uploadError);
                    showNotification("تنبيه", "تم حفظ الدفعة بدون صورة الإثبات", "warning");
                }
            }
            
            // إضافة الدفعة الجديدة
            const newPayment = {
                amount: amount,
                method: method,
                date: new Date(),
                notes: notes || "",
                proofUrl: proofUrl,
                proofData: proofData,
                addedBy: "system"
            };
            
            previousPayments.push(newPayment);
            totalPaid = newTotalPaid;
            
            // تحديث حالة الدفع
            const paymentStatus = calculatePaymentStatus(totalPaid, total);
            
            // تحديث حالة الطلب بناءً على المدفوعات
            // حالة الطلب تبقى كما هي ولا تتغير تلقائياً
            const newOrderStatus = order.status || 'pending';
            
            // تحديث الطلب في Firebase
            await db.collection("orders").doc(orderId).update({
                payments: previousPayments,
                'payment.amount': totalPaid,
                'payment.status': paymentStatus,
                'payment.method': method,
                'payment.proofUrl': proofUrl,
                'payment.proofData': proofData,
                'payment.lastPaymentDate': new Date(),
                status: newOrderStatus,
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            
            showNotification("نجاح", `تم إضافة دفعة جديدة بقيمة ${amount.toFixed(2)} ج.م (${method === 'cash' ? 'نقداً' : 'تحويل'})`, "success");
            
            // إغلاق النافذة الحالية
            closeNewPaymentModal();
            
            // إعادة تحميل بيانات المدفوعات إذا كانت النافذة مفتوحة
            if (document.getElementById("managePaymentsModal").classList.contains("active")) {
                manageOrderPayments(orderId);
            }
            
            // إعادة تحميل الطلبات
            loadOrders();
            
        } catch (error) {
            console.error("خطأ في حفظ الدفعة:", error);
            showNotification("خطأ", `فشل في حفظ الدفعة: ${error.message}`, "error");
        }
    };

    // إغلاق نافذة الدفعة الجديدة
    window.closeNewPaymentModal = () => {
        const modal = document.getElementById("newPaymentModal");
        if (modal) {
            modal.classList.remove("active");
            // إزالة النافذة من DOM بعد إغلاقها
            setTimeout(() => {
                if (modal.parentNode) {
                    modal.parentNode.removeChild(modal);
                }
            }, 300);
        }
    };

    // إرسال فاتورة الطلب عبر واتساب
    window.sendOrderInvoiceViaWhatsApp = async (orderId) => {
        try {
            const doc = await db.collection("orders").doc(orderId).get();
            
            if (!doc.exists) {
                showNotification("خطأ", "الطلب غير موجود", "error");
                return;
            }

            const order = doc.data();
            const customerPhone = order.customer?.phone;
            
            if (!customerPhone) {
                showNotification("تحذير", "لا يوجد رقم هاتف للعميل", "warning");
                return;
            }
            
            // حساب المدفوعات
            let totalPaid = 0;
            if (order.payments && order.payments.length > 0) {
                order.payments.forEach(p => totalPaid += p.amount || 0);
            } else {
                totalPaid = order.payment?.amount || 0;
            }
            
            const total = order.summary?.total || order.total || 0;
            const remaining = total - totalPaid;
            
            const itemsText = order.items?.map(item => 
                `• ${item.name} x ${item.quantity}: ${(item.price * item.quantity).toFixed(2)} ج.م`
            ).join('\n') || '';
            
            const message = `
                فاتورتك من متجر Abo Zahra 🛍️
                
                📋 رقم الطلب: ${order.orderNumber || `ORD-${orderId.slice(0, 8)}`}
                📅 التاريخ: ${order.createdAt?.toDate().toLocaleDateString('ar-EG') || 'غير محدد'}
                
                👤 العميل: ${order.customer?.name || 'غير محدد'}
                
                📦 المنتجات:
                ${itemsText}
                
                💰 المجموع الفرعي: ${order.summary?.subtotal?.toFixed(2) || '0.00'} ج.م
                💰 الخصم: ${order.summary?.discount?.toFixed(2) || '0.00'} ج.م
                🚚 الشحن: ${order.summary?.shipping?.toFixed(2) || '0.00'} ج.م
                💵 الإجمالي: ${total.toFixed(2)} ج.م
                
                💳 المدفوع: ${totalPaid.toFixed(2)} ج.م
                💵 المتبقي: ${remaining.toFixed(2)} ج.م
                
                📦 طريقة التوصيل: ${order.deliveryMethod === 'delivery' ? 'توصيل للعميل' : 'استلام من المتجر'}
                
                شكراً لثقتك بنا! 😊
                📞 للاستفسار: 01029149379
            `;
            
            openWhatsAppWithMessage(customerPhone, message);
            showNotification("نجاح", "جارٍ فتح واتساب لإرسال الفاتورة...", "success");
            
        } catch (error) {
            console.error("خطأ في إرسال الفاتورة:", error);
            showNotification("خطأ", "فشل في إرسال الفاتورة", "error");
        }
    };

    // إرسال تحديث حالة مباشر للعميل
    window.sendStatusUpdate = async (orderId, customerPhone, customerName, orderNumber) => {
        try {
            const doc = await db.collection("orders").doc(orderId).get();
            if (!doc.exists) {
                showNotification("خطأ", "الطلب غير موجود", "error");
                return;
            }

            const order = doc.data();
            const currentStatus = order.status || 'pending';
            
            // تعبئة البيانات في نموذج تغيير الحالة
            document.getElementById("statusOrderId").value = orderId;
            document.getElementById("statusCustomerPhone").value = customerPhone;
            document.getElementById("statusOrderNumber").value = orderNumber;
            document.getElementById("newStatus").value = currentStatus;
            document.getElementById("statusNotes").value = '';
            
            // فتح نافذة تغيير الحالة
            document.getElementById("changeStatusModal").classList.add("active");
            
        } catch (error) {
            console.error("خطأ في تحميل بيانات الطلب:", error);
            showNotification("خطأ", "فشل في تحميل بيانات الطلب", "error");
        }
    };

    // عرض صورة إثبات الدفع في نافذة منفصلة
    window.viewPaymentProof = (imageUrl) => {
        document.getElementById("paymentProofContent").innerHTML = `
            <img src="${imageUrl}" 
                 style="max-width: 100%; max-height: 400px; border-radius: 10px; margin-bottom: 15px;">
            <p style="margin-top: 10px;">
                <a href="${imageUrl}" target="_blank" style="color: #00c6ff; text-decoration: none;">
                    <i class="fas fa-external-link-alt"></i> فتح الصورة في نافذة جديدة
                </a>
            </p>
        `;
        document.getElementById("paymentProofModal").classList.add("active");
    };

    // إغلاق نافذة معاينة صورة الدفع
    window.closePaymentProofModal = () => {
        document.getElementById("paymentProofModal").classList.remove("active");
    };

    // إغلاق نافذة تفاصيل الطلب
    window.closeOrderDetailsModal = () => {
        document.getElementById("orderDetailsModal").classList.remove("active");
    };

    // تغيير حالة الطلب
    window.changeOrderStatus = async (orderId) => {
        try {
            const doc = await db.collection("orders").doc(orderId).get();
            
            if (!doc.exists) {
                showNotification("خطأ", "الطلب غير موجود", "error");
                return;
            }

            const order = doc.data();
            currentOrderData = order;
            
            // تعبئة البيانات في النموذج
            document.getElementById("statusOrderId").value = orderId;
            document.getElementById("statusCustomerPhone").value = order.customer?.phone || '';
            document.getElementById("statusOrderNumber").value = order.orderNumber || `ORD-${orderId.slice(0, 8)}`;
            document.getElementById("newStatus").value = order.status || 'pending';
            document.getElementById("statusNotes").value = order.statusNotes || '';
            
            // فتح النافذة
            document.getElementById("changeStatusModal").classList.add("active");
            
        } catch (error) {
            console.error("خطأ في تحميل بيانات الطلب:", error);
            showNotification("خطأ", "فشل في تحميل بيانات الطلب", "error");
        }
    };

    // إغلاق نافذة تغيير الحالة
    window.closeChangeStatusModal = () => {
        document.getElementById("changeStatusModal").classList.remove("active");
    };

    // تحديث حالة الطلب
    window.updateOrderStatus = async () => {
        const orderId = document.getElementById("statusOrderId").value;
        const newStatus = document.getElementById("newStatus").value;
        const notes = document.getElementById("statusNotes").value.trim();
        const customerPhone = document.getElementById("statusCustomerPhone").value;
        const orderNumber = document.getElementById("statusOrderNumber").value;
        const sendWhatsApp = document.getElementById("sendWhatsApp").checked;
        
        if (!orderId) {
            showNotification("خطأ", "رقم الطلب غير موجود", "error");
            return;
        }
        
        try {
            // تحديث حالة الطلب في Firebase
            await db.collection("orders").doc(orderId).update({
                status: newStatus,
                statusNotes: notes || "",
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            
            showNotification("نجاح", "تم تحديث حالة الطلب بنجاح", "success");
            
            // إذا كان ممكناً إرسال واتساب وكان الرقم متوفراً
            if (sendWhatsApp && customerPhone && currentOrderData) {
                const customerName = currentOrderData.customer?.name || 'العميل';
                const whatsappMessage = createStatusUpdateMessage(orderNumber, customerName, newStatus, notes);
                
                // حفظ الرسالة للعرض
                window.whatsappMessageToSend = whatsappMessage;
                window.whatsappCustomerPhone = customerPhone;
                window.whatsappOrderNumber = orderNumber;
                window.whatsappOrderId = orderId;
                
                // إعداد معاينة الرسالة
                document.getElementById("whatsappCustomerPhone").textContent = customerPhone;
                document.getElementById("whatsappOrderNumber").textContent = orderNumber;
                document.getElementById("whatsappMessagePreview").textContent = whatsappMessage;
                
                // فتح نافذة واتساب
                closeChangeStatusModal();
                setTimeout(() => {
                    document.getElementById("whatsappModal").classList.add("active");
                }, 300);
            } else {
                closeChangeStatusModal();
                loadOrders();
            }
            
        } catch (error) {
            console.error("خطأ في تحديث حالة الطلب:", error);
            showNotification("خطأ", `فشل في تحديث حالة الطلب: ${error.message}`, "error");
        }
    };

    // إرسال رسالة واتساب
    window.sendWhatsAppMessage = () => {
        if (!window.whatsappMessageToSend || !window.whatsappCustomerPhone) {
            showNotification("خطأ", "لا توجد رسالة لإرسالها", "error");
            return;
        }
        
        try {
            // فتح واتساب مع الرسالة
            const whatsappUrl = openWhatsAppWithMessage(window.whatsappCustomerPhone, window.whatsappMessageToSend);
            
            // تحديث حالة الطلب في Firebase
            if (window.whatsappOrderId) {
                db.collection("orders").doc(window.whatsappOrderId).update({
                    whatsappSent: true,
                    whatsappSentAt: firebase.firestore.FieldValue.serverTimestamp(),
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
            }
            
            showNotification("نجاح", "جارٍ فتح واتساب لإرسال التحديث...", "success");
            
            // إغلاق النافذة وإعادة تحميل الطلبات
            setTimeout(() => {
                closeWhatsAppModal();
                loadOrders();
            }, 2000);
            
        } catch (error) {
            console.error("خطأ في إرسال رسالة واتساب:", error);
            showNotification("خطأ", "حدث خطأ أثناء إرسال الرسالة", "error");
        }
    };

    // إغلاق نافذة واتساب
    window.closeWhatsAppModal = () => {
        document.getElementById("whatsappModal").classList.remove("active");
        // مسح البيانات المؤقتة
        window.whatsappMessageToSend = null;
        window.whatsappCustomerPhone = null;
        window.whatsappOrderNumber = null;
        window.whatsappOrderId = null;
    };

    // تحديث الطلبات
    window.refreshOrders = () => {
        loadOrders();
        showNotification("معلومات", "جاري تحديث الطلبات...", "info");
    };

    // ========== نظام الكاشير ==========

    // تحميل منتجات الكاشير
    function loadCashierProducts() {
        const productGrid = document.getElementById("productGrid");
        if (!productGrid) return;
        
        if (allProducts.length === 0) {
            productGrid.innerHTML = `
                <div class="empty-state" style="grid-column: 1 / -1;">
                    <i class="fas fa-box-open"></i>
                    <h3>لا توجد منتجات</h3>
                    <p>أضف منتجات من صفحة المنتجات</p>
                </div>
            `;
            return;
        }
        
        let productsHTML = "";
        
        allProducts.forEach((product, index) => {
            if (!product.inStock) return;
            
            const icon = getProductIcon(product.category);
            
            productsHTML += `
                <div class="product-grid-item" onclick="selectProductForBulkOrder('${product.id}')" id="product-${product.id}">
                    ${icon}
                    <div class="product-name">${product.name}</div>
                    <div class="product-price">${product.price.toFixed(2)} ج.م</div>
                    <div class="product-quantity">المتاح: ${product.quantity}</div>
                    
                    <button onclick="addToCart('${product.id}')" 
                            class="quick-action-btn" 
                            style="width: 100%; margin-top: 10px;">
                        <i class="fas fa-cart-plus"></i>
                        إضافة إلى السلة
                    </button>
                </div>
            `;
        });
        
        productGrid.innerHTML = productsHTML;
        
        // تحديث إحصائيات الكاشير
        updateCashierStats();
    }

    // تحديد منتج لطلب الكميات الكبيرة
    window.selectProductForBulkOrder = (productId) => {
        const product = allProducts.find(p => p.id === productId);
        if (!product) {
            showNotification("خطأ", "المنتج غير موجود", "error");
            return;
        }
        
        // تحديث المنتج المحدد
        selectedProduct = product;
        
        // تحديث التحديد البصري
        document.querySelectorAll('.product-grid-item').forEach(el => {
            el.classList.remove('selected');
        });
        document.getElementById(`product-${productId}`).classList.add('selected');
        
        // عرض معلومات المنتج المحدد
        const selectionArea = document.getElementById("productSelectionArea");
        const selectedProductInfo = document.getElementById("selectedProductInfo");
        
        if (selectionArea && selectedProductInfo) {
            selectionArea.style.display = 'block';
            selectedProductInfo.innerHTML = `
                <div class="selected-product-name">${product.name}</div>
                <div class="selected-product-details">
                    <span>${product.price.toFixed(2)} ج.م</span>
                    <span>المخزون: ${product.quantity}</span>
                </div>
            `;
        }
        
        // تعيين الكمية الافتراضية
        document.getElementById("selectedProductQuantity").value = 1;
        document.getElementById("bulkQuantity").value = 1;
        
        showNotification("معلومات", `تم تحديد المنتج: ${product.name}`, "info");
    };

    // الحصول على أيقونة المنتج حسب النوع
    function getProductIcon(category) {
        const icons = {
            'فيزا أمريكي': 'fas fa-credit-card',
            'فيزا أوروبي': 'fas fa-credit-card',
            'فيزا خليجي': 'fas fa-credit-card',
            'باسبور': 'fas fa-passport',
            'بطاقة هوية': 'fas fa-id-card',
            'شهادات': 'fas fa-certificate',
            'مستندات': 'fas fa-file-alt',
            'أخرى': 'fas fa-box'
        };
        
        const iconClass = icons[category] || 'fas fa-box';
        return `<i class="${iconClass}"></i>`;
    }

    // البحث عن المنتجات
    window.searchProducts = () => {
        const searchTerm = document.getElementById("productSearch").value.toLowerCase();
        const productItems = document.querySelectorAll('.product-grid-item');
        
        productItems.forEach(item => {
            const productName = item.querySelector('.product-name').textContent.toLowerCase();
            const productCategory = item.querySelector('.product-price')?.previousElementSibling?.textContent?.toLowerCase() || '';
            
            if (productName.includes(searchTerm) || productCategory.includes(searchTerm)) {
                item.style.display = 'block';
            } else {
                item.style.display = 'none';
            }
        });
    };

    // إضافة منتج سريع
    window.addQuickProduct = (name, price) => {
        const quickProduct = {
            id: 'quick_' + Date.now(),
            name: name,
            price: price,
            quantity: 1
        };
        
        addToCartItem(quickProduct);
    };

    // تفعيل وضع طلب الكميات الكبيرة
    window.enableBulkOrder = () => {
        bulkOrderMode = true;
        document.getElementById("bulkOrderPanel").style.display = "block";
        
        // إظهار منطقة اختيار المنتج
        const selectionArea = document.getElementById("productSelectionArea");
        if (selectionArea) {
            selectionArea.style.display = 'block';
        }
        
        showNotification("معلومات", "تم تفعيل وضع طلب الكميات الكبيرة - اختر منتجاً ثم أدخل الكمية", "info");
    };

    // تعطيل وضع طلب الكميات الكبيرة
    window.disableBulkOrder = () => {
        bulkOrderMode = false;
        document.getElementById("bulkOrderPanel").style.display = "none";
        
        // إخفاء منطقة اختيار المنتج
        const selectionArea = document.getElementById("productSelectionArea");
        if (selectionArea) {
            selectionArea.style.display = 'none';
        }
        
        // إزالة التحديد من المنتجات
        document.querySelectorAll('.product-grid-item').forEach(el => {
            el.classList.remove('selected');
        });
        
        selectedProduct = null;
        
        showNotification("معلومات", "تم تعطيل وضع طلب الكميات الكبيرة", "info");
    };

    // إضافة المنتج المحدد إلى السلة
    window.addSelectedProductToCart = () => {
        if (!selectedProduct) {
            showNotification("تحذير", "يرجى اختيار منتج أولاً", "warning");
            return;
        }
        
        const quantity = parseInt(document.getElementById("selectedProductQuantity").value) || 1;
        addProductToCartWithQuantity(selectedProduct.id, quantity);
    };

    // إضافة بالكمية من اللوحة العامة
    window.addWithBulkQuantity = () => {
        if (!selectedProduct) {
            showNotification("تحذير", "يرجى اختيار منتج أولاً", "warning");
            return;
        }
        
        const quantity = parseInt(document.getElementById("bulkQuantity").value) || 1;
        addProductToCartWithQuantity(selectedProduct.id, quantity);
    };

    // إضافة منتج مع الكمية
    function addProductToCartWithQuantity(productId, quantity) {
        const product = allProducts.find(p => p.id === productId);
        if (!product) {
            showNotification("خطأ", "المنتج غير موجود", "error");
            return;
        }
        
        if (quantity < 1) {
            showNotification("تحذير", "الكمية يجب أن تكون 1 على الأقل", "warning");
            return;
        }
        
        if (quantity > 100) {
            showNotification("تحذير", "الحد الأقصى للطلب هو 100 قطعة", "warning");
            return;
        }
        
        if (quantity > product.quantity) {
            showNotification("تحذير", `لا يوجد كمية كافية في المخزون. المتاح: ${product.quantity}`, "warning");
            return;
        }
        
        // إضافة المنتج بالكمية المطلوبة
        const existingItem = cart.find(item => item.id === productId);
        
        if (existingItem) {
            const newTotalQuantity = existingItem.quantity + quantity;
            if (newTotalQuantity > product.quantity) {
                showNotification("تحذير", `لا يمكن إضافة هذه الكمية. المجموع سيتجاوز المخزون المتاح`, "warning");
                return;
            }
            if (newTotalQuantity > 100) {
                showNotification("تحذير", `الحد الأقصى للطلب من هذا المنتج هو 100 قطعة`, "warning");
                return;
            }
            existingItem.quantity = newTotalQuantity;
        } else {
            cart.push({
                id: product.id,
                name: product.name,
                price: product.price,
                quantity: quantity,
                category: product.category,
                stock: product.quantity
            });
        }
        
        updateCartDisplay();
        showNotification("نجاح", `تم إضافة ${quantity} من ${product.name} إلى السلة`, "success");
    };

    // إضافة منتج إلى السلة
    window.addToCart = (productId) => {
        const product = allProducts.find(p => p.id === productId);
        if (!product) {
            showNotification("خطأ", "المنتج غير موجود", "error");
            return;
        }
        
        if (!product.inStock || product.quantity <= 0) {
            showNotification("تحذير", "المنتج غير متوفر في المخزون", "warning");
            return;
        }
        
        const existingItem = cart.find(item => item.id === productId);
        
        if (existingItem) {
            // التحقق من الحد الأقصى 100 قطعة
            if (existingItem.quantity >= 100) {
                showNotification("تحذير", "الحد الأقصى للطلب من هذا المنتج هو 100 قطعة", "warning");
                return;
            }
            
            if (existingItem.quantity >= product.quantity) {
                showNotification("تحذير", "لا يوجد كمية كافية في المخزون", "warning");
                return;
            }
            existingItem.quantity += 1;
        } else {
            cart.push({
                id: product.id,
                name: product.name,
                price: product.price,
                quantity: 1,
                category: product.category,
                stock: product.quantity
            });
        }
        
        updateCartDisplay();
        showNotification("نجاح", `تم إضافة ${product.name} إلى السلة`, "success");
    };

    // إضافة عنصر إلى السلة (داخلية)
    function addToCartItem(item) {
        const existingItem = cart.find(cartItem => cartItem.name === item.name);
        
        if (existingItem) {
            existingItem.quantity += 1;
        } else {
            cart.push({
                ...item,
                quantity: 1
            });
        }
        
        updateCartDisplay();
        showNotification("نجاح", `تم إضافة ${item.name} إلى السلة`, "success");
    }

    // تحديث عرض السلة
    function updateCartDisplay() {
        const cartItems = document.getElementById("cartItems");
        const subtotalElement = document.getElementById("subtotal");
        const shippingElement = document.getElementById("shipping");
        const totalElement = document.getElementById("total");
        const shippingRow = document.getElementById("shippingRow");
        
        if (cart.length === 0) {
            cartItems.innerHTML = `
                <div class="empty-state">
                    <i class="fas fa-shopping-cart"></i>
                    <h3>السلة فارغة</h3>
                    <p>أضف منتجات من القائمة</p>
                </div>
            `;
            subtotalElement.textContent = "0.00 ج.م";
            shippingElement.textContent = "0.00 ج.م";
            totalElement.textContent = "0.00 ج.م";
            shippingRow.style.display = "none";
            return;
        }
        
        let cartHTML = "";
        let subtotal = 0;
        
        cart.forEach((item, index) => {
            const itemTotal = item.price * item.quantity;
            subtotal += itemTotal;
            
            cartHTML += `
                <div class="cart-item">
                    <div class="cart-item-info">
                        <div class="cart-item-name">${item.name}</div>
                        <div class="cart-item-details">
                            <span class="cart-item-price">${item.price.toFixed(2)} ج.م</span>
                            <span style="color: #aaa; font-size: 12px; margin-right: 10px;">× ${item.quantity}</span>
                        </div>
                        <div class="cart-item-total" style="color: #4cd964; font-weight: bold;">
                            ${itemTotal.toFixed(2)} ج.م
                        </div>
                    </div>
                    <div class="cart-item-controls">
                        <div class="quantity-control">
                            <button class="quantity-btn" onclick="decreaseQuantity(${index})">
                                <i class="fas fa-minus"></i>
                            </button>
                            <input type="number" 
                                   class="quantity-input" 
                                   value="${item.quantity}" 
                                   min="1" 
                                   max="100"
                                   onchange="updateItemQuantity(${index}, this.value)"
                                   style="width: 60px; text-align: center;">
                            <button class="quantity-btn" onclick="increaseQuantity(${index})">
                                <i class="fas fa-plus"></i>
                            </button>
                        </div>
                        <button class="remove-item" onclick="removeFromCart(${index})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            `;
        });
        
        cartItems.innerHTML = cartHTML;
        
        // تحديث الإجماليات
        const discount = parseFloat(document.getElementById("discountInput").value) || 0;
        const total = subtotal - discount + shippingCost;
        
        subtotalElement.textContent = subtotal.toFixed(2) + " ج.م";
        document.getElementById("discount").textContent = discount.toFixed(2) + " ج.م";
        shippingElement.textContent = shippingCost.toFixed(2) + " ج.م";
        totalElement.textContent = total.toFixed(2) + " ج.م";
        
        // إظهار/إخفاء سطر الشحن
        if (shippingCost > 0) {
            shippingRow.style.display = "flex";
        } else {
            shippingRow.style.display = "none";
        }
        
        // تحديث حساب الباقي إذا كان الدفع نقداً
        if (selectedPaymentMethod === 'cash') {
            calculateChange();
        }
    }

    // تحديث كمية العنصر مباشرة
    window.updateItemQuantity = (index, newQuantity) => {
        newQuantity = parseInt(newQuantity) || 1;
        
        if (newQuantity < 1) {
            showNotification("تحذير", "الكمية يجب أن تكون 1 على الأقل", "warning");
            updateCartDisplay();
            return;
        }
        
        if (newQuantity > 100) {
            showNotification("تحذير", "الحد الأقصى للطلب هو 100 قطعة", "warning");
            cart[index].quantity = 100;
            updateCartDisplay();
            return;
        }
        
        const item = cart[index];
        const product = allProducts.find(p => p.id === item.id);
        
        if (product && newQuantity > product.quantity) {
            showNotification("تحذير", `لا يوجد كمية كافية في المخزون. المتاح: ${product.quantity}`, "warning");
            cart[index].quantity = product.quantity;
            updateCartDisplay();
            return;
        }
        
        cart[index].quantity = newQuantity;
        updateCartDisplay();
    };

    // زيادة كمية المنتج
    window.increaseQuantity = (index) => {
        const item = cart[index];
        const product = allProducts.find(p => p.id === item.id);
        
        // التحقق من الحد الأقصى 100 قطعة
        if (item.quantity >= 100) {
            showNotification("تحذير", "الحد الأقصى للطلب من هذا المنتج هو 100 قطعة", "warning");
            return;
        }
        
        if (product && item.quantity >= product.quantity) {
            showNotification("تحذير", "لا يوجد كمية كافية في المخزون", "warning");
            return;
        }
        
        item.quantity += 1;
        updateCartDisplay();
    };

    // تقليل كمية المنتج
    window.decreaseQuantity = (index) => {
        const item = cart[index];
        
        if (item.quantity > 1) {
            item.quantity -= 1;
            updateCartDisplay();
        } else {
            removeFromCart(index);
        }
    };

    // إزالة منتج من السلة
    window.removeFromCart = (index) => {
        cart.splice(index, 1);
        updateCartDisplay();
        showNotification("معلومات", "تم إزالة المنتج من السلة", "info");
    };

    // تحديث الخصم
    window.updateDiscount = () => {
        updateCartDisplay();
    };

    // تحديد طريقة التوصيل
    window.selectDeliveryMethod = (method) => {
        selectedDeliveryMethod = method;
        
        // تحديث التحديد البصري
        document.querySelectorAll('.delivery-option').forEach(el => {
            el.classList.remove('active');
        });
        event.target.closest('.delivery-option').classList.add('active');
        
        // إظهار/إخفاء حقول التوصيل
        const deliveryDetails = document.getElementById("deliveryDetails");
        if (method === 'delivery') {
            deliveryDetails.classList.add('active');
            // إعادة تعيين سعر الشحن
            shippingCost = parseFloat(document.getElementById("shippingCost").value) || 0;
        } else {
            deliveryDetails.classList.remove('active');
            shippingCost = 0;
            document.getElementById("shippingCost").value = "";
        }
        
        updateCartDisplay();
    };

    // تحديث تكلفة الشحن
    window.updateShipping = () => {
        shippingCost = parseFloat(document.getElementById("shippingCost").value) || 0;
        updateCartDisplay();
    };

    // تحديد طريقة الدفع
    window.selectPaymentMethod = (method) => {
        selectedPaymentMethod = method;
        
        // تحديث التحديد البصري
        document.querySelectorAll('.payment-method').forEach(el => {
            el.classList.remove('active');
        });
        event.target.closest('.payment-method').classList.add('active');
        
        // إظهار/إخفاء حقول الدفع النقدي
        const cashInputGroup = document.getElementById("cashInputGroup");
        const transferProofGroup = document.getElementById("transferProofGroup");
        
        if (method === 'cash') {
            cashInputGroup.style.display = 'block';
            transferProofGroup.style.display = 'none';
            calculateChange();
        } else {
            cashInputGroup.style.display = 'none';
            transferProofGroup.style.display = 'block';
            document.getElementById("changeDisplay").style.display = 'none';
            
            // إظهار حقل مبلغ التحويل
            document.getElementById("transferAmount").value = "";
        }
    };

    // إضافة إلى المبلغ المدفوع
    window.addToCashPaid = (amount) => {
        const cashPaidInput = document.getElementById("cashPaid");
        const currentValue = parseFloat(cashPaidInput.value) || 0;
        cashPaidInput.value = (currentValue + parseFloat(amount)).toFixed(2);
        calculateChange();
    };

    // مسح المبلغ المدفوع
    window.clearCashPaid = () => {
        document.getElementById("cashPaid").value = "";
        calculateChange();
    };

    // حساب الباقي
    window.calculateChange = () => {
        const total = parseFloat(document.getElementById("total").textContent) || 0;
        const cashPaid = parseFloat(document.getElementById("cashPaid").value) || 0;
        
        const changeDisplay = document.getElementById("changeDisplay");
        const changeAmount = document.getElementById("changeAmount");
        
        if (cashPaid > 0) {
            const change = cashPaid - total;
            changeAmount.textContent = change.toFixed(2);
            
            if (change >= 0) {
                changeDisplay.style.display = 'block';
                changeDisplay.style.color = '#4cd964';
                changeDisplay.innerHTML = `الباقي: <span id="changeAmount">${change.toFixed(2)}</span> ج.م`;
            } else {
                changeDisplay.style.display = 'block';
                changeDisplay.style.color = '#ff3b30';
                changeDisplay.innerHTML = `المبلغ غير كافي: <span id="changeAmount">${Math.abs(change).toFixed(2)}</span> ج.م`;
            }
        } else {
            changeDisplay.style.display = 'none';
        }
    };

    // معالجة الدفع النقدي
    window.processCashPayment = () => {
        const total = parseFloat(document.getElementById("total").textContent) || 0;
        const cashPaid = parseFloat(document.getElementById("cashPaid").value) || 0;
        
        // إزالة الشرط الإجباري لجعل الدفع غير شرط أن يكون كافي
        // المتابعة حتى لو كان المبلغ غير كافٍ
        processSale();
    };

    // مسح السلة
    window.clearCart = () => {
        if (cart.length === 0) {
            showNotification("معلومات", "السلة فارغة بالفعل", "info");
            return;
        }
        
        if (confirm("هل تريد مسح جميع المنتجات من السلة؟")) {
            cart = [];
            shippingCost = 0;
            selectedDeliveryMethod = 'pickup';
            transferProofImage = null;
            
            document.getElementById("discountInput").value = "";
            document.getElementById("cashPaid").value = "";
            document.getElementById("customerName").value = "";
            document.getElementById("customerPhone").value = "";
            document.getElementById("deliveryAddress").value = "";
            document.getElementById("shippingCost").value = "";
            document.getElementById("transferProof").value = "";
            document.getElementById("transferAmount").value = "";
            document.getElementById("transfer-file-name").textContent = "اختر صورة إثبات التحويل";
            document.getElementById("transferProofPreview").innerHTML = "";
            
            // إعادة تعيين التوصيل
            document.querySelectorAll('.delivery-option').forEach(el => el.classList.remove('active'));
            document.querySelector('.delivery-option[onclick*="pickup"]').classList.add('active');
            document.getElementById("deliveryDetails").classList.remove('active');
            
            updateCartDisplay();
            showNotification("نجاح", "تم مسح السلة بنجاح", "success");
        }
    };

    // معالجة البيع
    window.processSale = async () => {
        if (cart.length === 0) {
            showNotification("تحذير", "السلة فارغة، أضف منتجات أولاً", "warning");
            return;
        }
        
        const total = parseFloat(document.getElementById("total").textContent) || 0;
        if (total <= 0) {
            showNotification("خطأ", "المبلغ الإجمالي غير صحيح", "error");
            return;
        }
        
        const customerName = document.getElementById("customerName").value.trim();
        const customerPhone = document.getElementById("customerPhone").value.trim();
        
        if (!customerName) {
            showNotification("تحذير", "يرجى إدخال اسم العميل", "warning");
            document.getElementById("customerName").focus();
            return;
        }
        
        if (!customerPhone) {
            showNotification("تحذير", "يرجى إدخال رقم هاتف العميل", "warning");
            document.getElementById("customerPhone").focus();
            return;
        }
        
        // حساب المبلغ المدفوع
        let paidAmount = 0;
        if (selectedPaymentMethod === 'cash') {
            paidAmount = parseFloat(document.getElementById("cashPaid").value) || 0;
        } else if (selectedPaymentMethod === 'transfer') {
            paidAmount = parseFloat(document.getElementById("transferAmount").value) || 0;
            if (paidAmount <= 0) {
                showNotification("تحذير", "يرجى إدخال مبلغ التحويل", "warning");
                document.getElementById("transferAmount").focus();
                return;
            }
        }
        
        // تأكيد البيع
        const remaining = total - paidAmount;
        const confirmMessage = remaining > 0 ? 
            `هل تريد إنهاء عملية البيع؟\nالمبلغ الإجمالي: ${total.toFixed(2)} ج.م\nالمبلغ المدفوع: ${paidAmount.toFixed(2)} ج.م\nالمبلغ المتبقي: ${remaining.toFixed(2)} ج.م` :
            `هل تريد إنهاء عملية البيع بقيمة ${total.toFixed(2)} ج.م؟`;
        
        if (!confirm(confirmMessage)) {
            return;
        }
        
        try {
            // رفع صورة التحويل إذا كانت موجودة (اختياري)
            let proofUrl = null;
            let proofData = null;
            
            if (selectedPaymentMethod === 'transfer') {
                const proofFile = document.getElementById("transferProof").files[0];
                
                if (proofFile) {
                    showNotification("معلومات", "جاري رفع صورة إثبات التحويل...", "info");
                    
                    try {
                        proofData = await uploadImageToImgBB(proofFile);
                        proofUrl = proofData.url;
                        console.log("✅ تم رفع صورة التحويل بنجاح:", proofUrl);
                    } catch (uploadError) {
                        console.warn("⚠️ خطأ في رفع صورة التحويل:", uploadError);
                        showNotification("تنبيه", "فشل في رفع صورة التحويل، جاري الاستمرار بدون الصورة", "warning");
                    }
                }
            }
            
            // تحديث المخزون
            const batch = db.batch();
            const stockUpdates = [];
            
            for (const item of cart) {
                const product = allProducts.find(p => p.id === item.id);
                if (product) {
                    const newQuantity = product.quantity - item.quantity;
                    if (newQuantity < 0) {
                        throw new Error(`الكمية غير كافية للمنتج: ${product.name}`);
                    }
                    
                    const productRef = db.collection("products").doc(product.id);
                    batch.update(productRef, {
                        quantity: newQuantity,
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    
                    stockUpdates.push({
                        productId: product.id,
                        oldQuantity: product.quantity,
                        newQuantity: newQuantity
                    });
                }
            }
            
            // تحديد حالة الدفع
            const paymentStatus = calculatePaymentStatus(paidAmount, total);
            
            // تحضير بيانات الدفع
            const paymentData = {
                method: selectedPaymentMethod,
                amount: paidAmount,
                status: paymentStatus,
                date: new Date() // استخدام new Date() للتاريخ
            };
            
            if (selectedPaymentMethod === 'transfer' && proofUrl) {
                paymentData.proofUrl = proofUrl;
                paymentData.proofData = proofData;
            }
            
            // إضافة الطلب إلى Firebase
            const orderData = {
                items: cart.map(item => ({
                    name: item.name,
                    price: item.price,
                    quantity: item.quantity,
                    total: item.price * item.quantity
                })),
                summary: {
                    subtotal: parseFloat(document.getElementById("subtotal").textContent),
                    discount: parseFloat(document.getElementById("discount").textContent),
                    shipping: shippingCost,
                    total: total
                },
                payments: [paymentData],
                payment: {
                    ...paymentData,
                    date: firebase.firestore.FieldValue.serverTimestamp()
                },
                customer: {
                    name: customerName,
                    phone: customerPhone
                },
                deliveryMethod: selectedDeliveryMethod,
                status: 'pending', // تبدأ دائماً "قيد الانتظار"
                type: 'cashier_sale',
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            };
            
            // إضافة بيانات التوصيل إذا كانت موجودة
            if (selectedDeliveryMethod === 'delivery') {
                const deliveryAddress = document.getElementById("deliveryAddress").value.trim();
                orderData.delivery = {
                    method: 'delivery',
                    address: deliveryAddress,
                    cost: shippingCost
                };
            }
            
            const orderRef = db.collection("orders").doc();
            batch.set(orderRef, orderData);
            
            // تنفيذ جميع العمليات
            await batch.commit();
            
            // حفظ بيانات البيع الحالي
            currentSale = {
                id: orderRef.id,
                ...orderData,
                createdAt: new Date()
            };
            
            // تحديث الإحصائيات اليومية
            updateDailyStats(total);
            
            // إعادة تعيين السلة
            cart = [];
            shippingCost = 0;
            selectedDeliveryMethod = 'pickup';
            transferProofImage = null;
            
            document.getElementById("discountInput").value = "";
            document.getElementById("cashPaid").value = "";
            document.getElementById("customerName").value = "";
            document.getElementById("customerPhone").value = "";
            document.getElementById("deliveryAddress").value = "";
            document.getElementById("shippingCost").value = "";
            document.getElementById("transferProof").value = "";
            document.getElementById("transferAmount").value = "";
            document.getElementById("transfer-file-name").textContent = "اختر صورة إثبات التحويل";
            document.getElementById("transferProofPreview").innerHTML = "";
            
            // إعادة تعيين التوصيل
            document.querySelectorAll('.delivery-option').forEach(el => el.classList.remove('active'));
            document.querySelector('.delivery-option[onclick*="pickup"]').classList.add('active');
            document.getElementById("deliveryDetails").classList.remove('active');
            
            updateCartDisplay();
            
            // عرض الفاتورة
            showInvoice();
            
            showNotification("نجاح", `تم إنهاء عملية البيع بنجاح - المبلغ الإجمالي: ${total.toFixed(2)} ج.م - المبلغ المدفوع: ${paidAmount.toFixed(2)} ج.م - المبلغ المتبقي: ${remaining.toFixed(2)} ج.م`, "success");
            
            // إعادة تحميل المنتجات والطلبات
            loadProducts();
            loadOrders();
            
        } catch (error) {
            console.error("خطأ في معالجة البيع:", error);
            showNotification("خطأ", `فشل في معالجة البيع: ${error.message}`, "error");
        }
    };

    // تحديث الإحصائيات اليومية
    function updateDailyStats(amount) {
        dailyStats.salesCount++;
        dailyStats.revenue += amount;
        dailyStats.transactions.push({
            time: new Date(),
            amount: amount
        });
        
        updateCashierStats();
    }

    // تحديث إحصائيات الكاشير
    function updateCashierStats() {
        const availableProducts = allProducts.filter(p => p.inStock).length;
        const salesCount = dailyStats.salesCount;
        const revenue = dailyStats.revenue;
        
        document.getElementById("cashierProducts").textContent = availableProducts;
        document.getElementById("cashierSales").textContent = salesCount;
        document.getElementById("cashierRevenue").textContent = revenue.toFixed(2) + " ج.م";
        
        loadRecentSales();
    }

    // تحميل المبيعات الحديثة
    function loadRecentSales() {
        const recentSales = document.getElementById("recentSales");
        if (!recentSales) return;
        
        if (dailyStats.transactions.length === 0) {
            recentSales.innerHTML = `
                <div class="empty-state" style="padding: 20px;">
                    <i class="fas fa-history"></i>
                    <h4>لا توجد مبيعات حديثة</h4>
                </div>
            `;
            return;
        }
        
        let salesHTML = '<div class="orders-list">';
        
        dailyStats.transactions.slice(-5).reverse().forEach((transaction, index) => {
            const time = transaction.time.toLocaleTimeString('ar-EG');
            
            salesHTML += `
                <div class="order-item">
                    <div class="order-info">
                        <h4>بيع #${dailyStats.transactions.length - index}</h4>
                        <div class="order-details">
                            <span><i class="fas fa-clock"></i> ${time}</span>
                            <span><i class="fas fa-money-bill"></i> ${transaction.amount.toFixed(2)} جنيه</span>
                        </div>
                    </div>
                    <div class="order-status status-completed">
                        مكتمل
                    </div>
                </div>
            `;
        });
        
        salesHTML += '</div>';
        recentSales.innerHTML = salesHTML;
    }

    // عرض الفاتورة
    function showInvoice() {
        if (!currentSale) return;
        
        const invoiceContent = document.getElementById("invoiceContent");
        
        // حساب المدفوعات والمتبقي
        const total = currentSale.summary.total;
        const paid = currentSale.payment?.amount || 0;
        const remaining = total - paid;
        
        const itemsHTML = currentSale.items.map(item => `
            <div class="receipt-item">
                <div>${item.name} x ${item.quantity}</div>
                <div>${item.total.toFixed(2)} ج.م</div>
            </div>
        `).join('');
        
        const deliveryInfo = currentSale.deliveryMethod === 'delivery' ? `
            <div style="margin-top: 10px; padding-top: 10px; border-top: 1px dashed #000;">
                <p>طريقة التوصيل: توصيل للعميل</p>
                <p>عنوان التوصيل: ${currentSale.delivery?.address || 'غير محدد'}</p>
                <p>تكلفة الشحن: ${(currentSale.delivery?.cost || 0).toFixed(2)} ج.م</p>
            </div>
        ` : `
            <div style="margin-top: 10px; padding-top: 10px; border-top: 1px dashed #000;">
                <p>طريقة التوصيل: استلام من المتجر</p>
            </div>
        `;
        
        const paymentInfo = currentSale.payment?.method === 'transfer' ? `
            <div style="margin-top: 10px; padding: 10px; background: #f8f9fa; border-radius: 5px; border: 1px dashed #000;">
                <p>طريقة الدفع: تحويل بنكي</p>
                <p>المبلغ المحول: ${paid.toFixed(2)} ج.م</p>
                ${remaining > 0 ? `<p style="color: #dc3545; font-weight: bold;">المبلغ المتبقي: ${remaining.toFixed(2)} ج.م</p>` : ''}
            </div>
        ` : `
            <div style="margin-top: 10px; padding: 10px; background: #f8f9fa; border-radius: 5px; border: 1px dashed #000;">
                <p>طريقة الدفع: نقداً</p>
                <p>المبلغ المدفوع: ${paid.toFixed(2)} ج.م</p>
                ${remaining > 0 ? `<p style="color: #dc3545; font-weight: bold;">المبلغ المتبقي: ${remaining.toFixed(2)} ج.م</p>` : ''}
            </div>
        `;
        
        const invoiceHTML = `
            <div class="receipt-header">
                <h2 style="margin-bottom: 10px;">فاتورة بيع</h2>
                <p>متجر Abo Zahra</p>
                <p>${new Date().toLocaleDateString('ar-EG')} ${new Date().toLocaleTimeString('ar-EG')}</p>
                <p>رقم الفاتورة: ${currentSale.id.slice(0, 8)}</p>
            </div>
            
            <div class="receipt-items">
                ${itemsHTML}
            </div>
            
            <div class="receipt-total">
                <div class="receipt-item">
                    <div>المجموع الفرعي:</div>
                    <div>${currentSale.summary.subtotal.toFixed(2)} ج.م</div>
                </div>
                <div class="receipt-item">
                    <div>الخصم:</div>
                    <div>-${currentSale.summary.discount.toFixed(2)} ج.م</div>
                </div>
                ${currentSale.summary.shipping > 0 ? `
                <div class="receipt-item">
                    <div>مصاريف الشحن:</div>
                    <div>${currentSale.summary.shipping.toFixed(2)} ج.م</div>
                </div>
                ` : ''}
                <div class="receipt-item" style="font-weight: bold; font-size: 18px;">
                    <div>الإجمالي:</div>
                    <div>${total.toFixed(2)} ج.م</div>
                </div>
                <div class="receipt-item" style="color: #28a745; font-weight: bold;">
                    <div>المبلغ المدفوع:</div>
                    <div>${paid.toFixed(2)} ج.م</div>
                </div>
                ${remaining > 0 ? `
                <div class="receipt-item" style="color: #dc3545; font-weight: bold;">
                    <div>المبلغ المتبقي:</div>
                    <div>${remaining.toFixed(2)} ج.م</div>
                </div>
                ` : `
                <div class="receipt-item" style="color: #28a745; font-weight: bold;">
                    <div>المبلغ المتبقي:</div>
                    <div>0.00 ج.م (مدفوع بالكامل)</div>
                </div>
                `}
            </div>
            
            ${deliveryInfo}
            ${paymentInfo}
            
            <div style="margin-top: 20px; padding-top: 10px; border-top: 1px dashed #000;">
                <p>اسم العميل: ${currentSale.customer.name}</p>
                <p>هاتف العميل: ${currentSale.customer.phone}</p>
            </div>
            
            <div style="text-align: center; margin-top: 20px; font-size: 12px;">
                <p>شكراً لزيارتكم</p>
                <p>📞 للاستفسار: 01029149379</p>
            </div>
        `;
        
        invoiceContent.innerHTML = invoiceHTML;
        document.getElementById("invoiceModal").classList.add("active");
    }

    // إغلاق نافذة الفاتورة
    window.closeInvoiceModal = () => {
        document.getElementById("invoiceModal").classList.remove("active");
    };

    // طباعة الفاتورة
    window.printInvoice = () => {
        const printContent = document.getElementById("invoiceContent").innerHTML;
        const originalContent = document.body.innerHTML;
        
        document.body.innerHTML = `
            <!DOCTYPE html>
            <html dir="rtl">
            <head>
                <title>طباعة الفاتورة</title>
                <style>
                    body {
                        font-family: Arial, sans-serif;
                        padding: 20px;
                        direction: rtl;
                    }
                    @media print {
                        @page {
                            size: auto;
                            margin: 0;
                        }
                    }
                </style>
            </head>
            <body>
                ${printContent}
                <script>
                    window.onload = function() {
                        window.print();
                        setTimeout(function() {
                            window.close();
                        }, 1000);
                    }
                <\/script>
            </body>
            </html>
        `;
        
        window.print();
        
        // العودة إلى المحتوى الأصلي
        document.body.innerHTML = originalContent;
        location.reload();
    };

    // إرسال الفاتورة عبر واتساب
    window.sendInvoiceViaWhatsApp = () => {
        if (!currentSale) {
            showNotification("خطأ", "لا توجد فاتورة للإرسال", "error");
            return;
        }
        
        const customerPhone = currentSale.customer.phone;
        if (!customerPhone) {
            showNotification("تحذير", "لا يوجد رقم هاتف للعميل", "warning");
            return;
        }
        
        // حساب المدفوعات والمتبقي
        const total = currentSale.summary.total;
        const paid = currentSale.payment?.amount || 0;
        const remaining = total - paid;
        
        const deliveryInfo = currentSale.deliveryMethod === 'delivery' ? `
            🚚 طريقة التوصيل: توصيل للعميل
            📍 عنوان التوصيل: ${currentSale.delivery?.address || 'غير محدد'}
            💰 تكلفة الشحن: ${(currentSale.delivery?.cost || 0).toFixed(2)} ج.م
        ` : `
            🚚 طريقة التوصيل: استلام من المتجر
        `;
        
        const paymentMethod = currentSale.payment?.method === 'transfer' ? 'تحويل بنكي' : 'نقداً';
        
        const message = `
            فاتورتك من متجر Abo Zahra 🛍️
            
            📋 رقم الفاتورة: ${currentSale.id.slice(0, 8)}
            📅 التاريخ: ${new Date().toLocaleDateString('ar-EG')}
            
            👤 العميل: ${currentSale.customer.name}
            📞 الهاتف: ${customerPhone}
            
            📦 المنتجات:
            ${currentSale.items.map(item => `• ${item.name} x ${item.quantity}: ${item.total.toFixed(2)} ج.م`).join('\n')}
            
            💰 المجموع الفرعي: ${currentSale.summary.subtotal.toFixed(2)} ج.م
            💰 الخصم: ${currentSale.summary.discount.toFixed(2)} ج.م
            🚚 الشحن: ${currentSale.summary.shipping.toFixed(2)} ج.م
            💵 الإجمالي: ${total.toFixed(2)} ج.م
            
            💳 طريقة الدفع: ${paymentMethod}
            💵 المبلغ المدفوع: ${paid.toFixed(2)} ج.م
            ${remaining > 0 ? `💰 المبلغ المتبقي: ${remaining.toFixed(2)} ج.م` : '✅ تم الدفع بالكامل'}
            
            ${deliveryInfo}
            
            شكراً لثقتك بنا! 😊
            📞 للاستفسار: 01029149379
        `;
        
        openWhatsAppWithMessage(customerPhone, message);
        showNotification("نجاح", "جارٍ فتح واتساب لإرسال الفاتورة...", "success");
    };

    // ========== تقرير المدفوعات ==========

    // عرض صفحة تقرير المدفوعات
    window.showPaymentsReport = () => {
        // إخفاء جميع الصفحات وإظهار صفحة المدفوعات
        document.getElementById("productsPage").style.display = "none";
        document.getElementById("ordersPage").style.display = "none";
        document.getElementById("cashierPage").style.display = "none";
        document.getElementById("paymentsPage").style.display = "block";
        
        // تحديث أزرار التنقل
        document.getElementById("productsBtn").classList.remove('active');
        document.getElementById("ordersBtn").classList.remove('active');
        document.getElementById("cashierBtn").classList.remove('active');
        document.getElementById("paymentsBtn").classList.add('active');
        
        // تحميل التقرير
        loadPaymentsReport();
    };

    // تحميل تقرير المدفوعات
    window.loadPaymentsReport = async () => {
        const startDate = document.getElementById("startDate")?.value;
        const endDate = document.getElementById("endDate")?.value;
        const methodFilter = document.getElementById("paymentMethodFilter")?.value;
        
        try {
            let query = db.collection("orders");
            
            // تطبيق الفلتر حسب التاريخ إذا كان موجوداً
            if (startDate) {
                const start = new Date(startDate);
                start.setHours(0, 0, 0, 0);
                query = query.where("createdAt", ">=", start);
            }
            
            if (endDate) {
                const end = new Date(endDate);
                end.setHours(23, 59, 59, 999);
                query = query.where("createdAt", "<=", end);
            }
            
            const querySnapshot = await query.get();
            
            let totalCash = 0;
            let totalTransfer = 0;
            let totalPaid = 0;
            let totalOrders = 0;
            let pendingPayments = 0;
            
            let paymentsDetailsHTML = '<div class="orders-list">';
            
            querySnapshot.forEach(doc => {
                const order = doc.data();
                totalOrders++;
                
                // حساب المدفوعات لهذا الطلب
                const payments = order.payments || [];
                let orderCash = 0;
                let orderTransfer = 0;
                let orderPaid = 0;
                
                payments.forEach(payment => {
                    if (methodFilter === 'all' || payment.method === methodFilter) {
                        if (payment.method === 'cash') {
                            orderCash += payment.amount || 0;
                        } else if (payment.method === 'transfer') {
                            orderTransfer += payment.amount || 0;
                        }
                        orderPaid += payment.amount || 0;
                    }
                });
                
                totalCash += orderCash;
                totalTransfer += orderTransfer;
                totalPaid += orderPaid;
                
                // حساب المتبقي
                const orderTotal = order.summary?.total || order.total || 0;
                const remaining = orderTotal - orderPaid;
                
                if (remaining > 0) {
                    pendingPayments++;
                }
                
                // إضافة إلى تفاصيل المدفوعات
                const orderDate = order.createdAt ? 
                    order.createdAt.toDate().toLocaleDateString('ar-EG') : 
                    'غير محدد';
                
                paymentsDetailsHTML += `
                    <div class="order-item">
                        <div class="order-info">
                            <h4>${order.orderNumber || `ORD-${doc.id.slice(0, 8)}`}</h4>
                            <p>${order.customer?.name || 'غير محدد'}</p>
                            <div class="order-details">
                                <span><i class="fas fa-calendar"></i> ${orderDate}</span>
                                <span><i class="fas fa-money-bill"></i> ${orderPaid.toFixed(2)} / ${orderTotal.toFixed(2)} ج.م</span>
                                <span style="color: ${remaining > 0 ? '#ff6b6b' : '#4cd964'}">
                                    ${remaining > 0 ? `متبقي: ${remaining.toFixed(2)} ج.م` : 'مدفوع بالكامل'}
                                </span>
                            </div>
                        </div>
                        <div class="action-buttons">
                            <button onclick="manageOrderPayments('${doc.id}')" class="btn-edit">
                                <i class="fas fa-money-bill-wave"></i>
                                إدارة
                            </button>
                        </div>
                    </div>
                `;
            });
            
            paymentsDetailsHTML += '</div>';
            document.getElementById("paymentsDetails").innerHTML = paymentsDetailsHTML;
            
            // تحديث الإحصائيات
            const paymentsStatsHTML = `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-top: 15px;">
                    <div style="background: rgba(255, 255, 255, 0.05); padding: 15px; border-radius: 10px;">
                        <div style="font-size: 24px; font-weight: bold; color: #00c6ff;">${totalOrders}</div>
                        <div style="color: #aaa;">عدد الطلبات</div>
                    </div>
                    <div style="background: rgba(255, 255, 255, 0.05); padding: 15px; border-radius: 10px;">
                        <div style="font-size: 24px; font-weight: bold; color: #ffcc00;">${totalCash.toFixed(2)} ج.م</div>
                        <div style="color: #aaa;">النقدي</div>
                    </div>
                    <div style="background: rgba(255, 255, 255, 0.05); padding: 15px; border-radius: 10px;">
                        <div style="font-size: 24px; font-weight: bold; color: #9b59b6;">${totalTransfer.toFixed(2)} ج.م</div>
                        <div style="color: #aaa;">التحويل</div>
                    </div>
                    <div style="background: rgba(255, 255, 255, 0.05); padding: 15px; border-radius: 10px;">
                        <div style="font-size: 24px; font-weight: bold; color: #4cd964;">${totalPaid.toFixed(2)} ج.م</div>
                        <div style="color: #aaa;">إجمالي المدفوعات</div>
                    </div>
                </div>
                ${pendingPayments > 0 ? `
                <div style="margin-top: 20px; padding: 15px; background: rgba(255, 107, 107, 0.1); border-radius: 10px; border: 1px solid rgba(255, 107, 107, 0.3);">
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <i class="fas fa-exclamation-circle" style="color: #ff6b6b;"></i>
                        <div>
                            <div style="font-weight: bold; color: #ff6b6b;">تنبيه: هناك ${pendingPayments} طلب بها مدفوعات متبقية</div>
                            <div style="color: #aaa; font-size: 14px; margin-top: 5px;">يجب متابعة هذه الطلبات لتحصيل المدفوعات المتبقية</div>
                        </div>
                    </div>
                </div>
                ` : ''}
            `;
            
            document.getElementById("paymentsStats").innerHTML = paymentsStatsHTML;
            
        } catch (error) {
            console.error("خطأ في تحميل تقرير المدفوعات:", error);
            showNotification("خطأ", "فشل في تحميل تقرير المدفوعات", "error");
        }
    };

    // ========== وظائف عامة ==========

    // حذف منتج أو طلب
    window.showDeleteConfirmation = (id, type, name) => {
        itemToDelete = id;
        deleteType = type;
        const deleteMessage = document.getElementById("deleteMessage");
        const confirmDeleteModal = document.getElementById("confirmDeleteModal");
        
        if (deleteMessage) deleteMessage.textContent = `هل أنت متأكد من حذف ${name}؟`;
        if (confirmDeleteModal) confirmDeleteModal.classList.add("active");
    };

    window.confirmDelete = async () => {
        if (!itemToDelete || !deleteType) return;

        try {
            if (deleteType === 'product') {
                await db.collection("products").doc(itemToDelete).delete();
                showNotification("نجاح", "تم حذف المنتج بنجاح", "success");
                loadProducts();
            } else if (deleteType === 'order') {
                await db.collection("orders").doc(itemToDelete).delete();
                showNotification("نجاح", "تم حذف الطلب بنجاح", "success");
                loadOrders();
            }
        } catch (error) {
            console.error("خطأ في الحذف:", error);
            showNotification("خطأ", `فشل في الحذف: ${error.message}`, "error");
        } finally {
            closeConfirmDeleteModal();
        }
    };

    window.closeConfirmDeleteModal = () => {
        const confirmDeleteModal = document.getElementById("confirmDeleteModal");
        if (confirmDeleteModal) confirmDeleteModal.classList.remove("active");
        itemToDelete = null;
        deleteType = null;
    };

    // الحذف الجماعي للمنتجات
    window.toggleProductSelection = (productId) => {
        if (selectedProductsForDelete.has(productId)) {
            selectedProductsForDelete.delete(productId);
        } else {
            selectedProductsForDelete.add(productId);
        }
    };

    window.showBulkDeleteModal = () => {
        const listContainer = document.getElementById("bulkDeleteProductsList");
        const bulkDeleteModal = document.getElementById("bulkDeleteModal");
        
        if (!listContainer || !bulkDeleteModal) return;
        
        listContainer.innerHTML = "";
        
        if (allProducts.length === 0) {
            listContainer.innerHTML = '<p style="color: #aaa; text-align: center;">لا توجد منتجات متاحة</p>';
        } else {
            allProducts.forEach(product => {
                listContainer.innerHTML += `
                    <div class="checkbox-group">
                        <input type="checkbox" id="bulk-product-${product.id}" 
                               ${selectedProductsForDelete.has(product.id) ? 'checked' : ''}
                               onchange="toggleProductSelection('${product.id}')">
                        <label for="bulk-product-${product.id}">${product.name} - ${product.price.toFixed(2)} جنيه</label>
                    </div>
                `;
            });
        }
        
        bulkDeleteModal.classList.add("active");
    };

    window.closeBulkDeleteModal = () => {
        const bulkDeleteModal = document.getElementById("bulkDeleteModal");
        if (bulkDeleteModal) bulkDeleteModal.classList.remove("active");
    };

    window.confirmBulkDelete = async () => {
        if (selectedProductsForDelete.size === 0) {
            showNotification("تحذير", "لم تختر أي منتجات للحذف", "warning");
            return;
        }

        if (!confirm(`هل أنت متأكد من حذف ${selectedProductsForDelete.size} منتج(ات)؟`)) {
            return;
        }

        try {
            const batch = db.batch();
            selectedProductsForDelete.forEach(productId => {
                const productRef = db.collection("products").doc(productId);
                batch.delete(productRef);
            });
            
            await batch.commit();
            
            showNotification("نجاح", `تم حذف ${selectedProductsForDelete.size} منتج(ات) بنجاح`, "success");
            selectedProductsForDelete.clear();
            closeBulkDeleteModal();
            loadProducts();
        } catch (error) {
            console.error("خطأ في الحذف الجماعي للمنتجات:", error);
            showNotification("خطأ", `فشل في حذف المنتجات: ${error.message}`, "error");
        }
    };

    // الحذف الجماعي للطلبات
    window.toggleOrderSelection = (orderId) => {
        if (selectedOrdersForDelete.has(orderId)) {
            selectedOrdersForDelete.delete(orderId);
        } else {
            selectedOrdersForDelete.add(orderId);
        }
    };

    window.bulkDeleteOrders = async () => {
        if (selectedOrdersForDelete.size === 0) {
            showNotification("تحذير", "لم تختر أي طلبات للحذف", "warning");
            return;
        }

        if (!confirm(`هل أنت متأكد من حذف ${selectedOrdersForDelete.size} طلب(ات)؟`)) {
            return;
        }

        try {
            const batch = db.batch();
            selectedOrdersForDelete.forEach(orderId => {
                const orderRef = db.collection("orders").doc(orderId);
                batch.delete(orderRef);
            });
            
            await batch.commit();
            
            showNotification("نجاح", `تم حذف ${selectedOrdersForDelete.size} طلب(ات) بنجاح`, "success");
            selectedOrdersForDelete.clear();
            loadOrders();
        } catch (error) {
            console.error("خطأ في الحذف الجماعي للطلبات:", error);
            showNotification("خطأ", `فشل في حذف الطلبات: ${error.message}`, "error");
        }
    };

    // التنقل بين الصفحات
    window.showProducts = () => {
        const productsPage = document.getElementById("productsPage");
        const ordersPage = document.getElementById("ordersPage");
        const cashierPage = document.getElementById("cashierPage");
        const paymentsPage = document.getElementById("paymentsPage");
        const productsBtn = document.getElementById("productsBtn");
        const ordersBtn = document.getElementById("ordersBtn");
        const cashierBtn = document.getElementById("cashierBtn");
        const paymentsBtn = document.getElementById("paymentsBtn");
        
        if (productsPage) productsPage.style.display = "block";
        if (ordersPage) ordersPage.style.display = "none";
        if (cashierPage) cashierPage.style.display = "none";
        if (paymentsPage) paymentsPage.style.display = "none";
        if (productsBtn) productsBtn.classList.add("active");
        if (ordersBtn) ordersBtn.classList.remove("active");
        if (cashierBtn) cashierBtn.classList.remove("active");
        if (paymentsBtn) paymentsBtn.classList.remove("active");
        
        loadProducts();
    };

    window.showOrders = () => {
        const productsPage = document.getElementById("productsPage");
        const ordersPage = document.getElementById("ordersPage");
        const cashierPage = document.getElementById("cashierPage");
        const paymentsPage = document.getElementById("paymentsPage");
        const productsBtn = document.getElementById("productsBtn");
        const ordersBtn = document.getElementById("ordersBtn");
        const cashierBtn = document.getElementById("cashierBtn");
        const paymentsBtn = document.getElementById("paymentsBtn");
        
        if (productsPage) productsPage.style.display = "none";
        if (ordersPage) ordersPage.style.display = "block";
        if (cashierPage) cashierPage.style.display = "none";
        if (paymentsPage) paymentsPage.style.display = "none";
        if (productsBtn) productsBtn.classList.remove("active");
        if (ordersBtn) ordersBtn.classList.add("active");
        if (cashierBtn) cashierBtn.classList.remove("active");
        if (paymentsBtn) paymentsBtn.classList.remove("active");
        
        loadOrders();
    };

    window.showCashier = () => {
        const productsPage = document.getElementById("productsPage");
        const ordersPage = document.getElementById("ordersPage");
        const cashierPage = document.getElementById("cashierPage");
        const paymentsPage = document.getElementById("paymentsPage");
        const productsBtn = document.getElementById("productsBtn");
        const ordersBtn = document.getElementById("ordersBtn");
        const cashierBtn = document.getElementById("cashierBtn");
        const paymentsBtn = document.getElementById("paymentsBtn");
        
        if (productsPage) productsPage.style.display = "none";
        if (ordersPage) ordersPage.style.display = "none";
        if (cashierPage) cashierPage.style.display = "block";
        if (paymentsPage) paymentsPage.style.display = "none";
        if (productsBtn) productsBtn.classList.remove("active");
        if (ordersBtn) ordersBtn.classList.remove("active");
        if (cashierBtn) cashierBtn.classList.add("active");
        if (paymentsBtn) paymentsBtn.classList.remove("active");
        
        loadCashierProducts();
        updateCashierStats();
    };

    // تهيئة التطبيق عند التحميل
    window.addEventListener("DOMContentLoaded", () => {
        console.log("✅ لوحة التحكم جاهزة للتحميل...");
        
        // تعيين حدث لملف الصورة
        const imageInput = document.getElementById("image");
        const fileName = document.getElementById("file-name");
        
        if (imageInput && fileName) {
            imageInput.addEventListener("change", function() {
                if (this.files && this.files[0]) {
                    const file = this.files[0];
                    fileName.textContent = file.name;
                    
                    // عرض معاينة الصورة
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const imagePreview = document.getElementById("imagePreview");
                        imagePreview.innerHTML = `
                            <p style="color: #4cd964; margin-bottom: 10px;">
                                <i class="fas fa-image"></i> معاينة الصورة:
                            </p>
                            <img src="${e.target.result}" style="max-width: 200px; max-height: 150px; border-radius: 10px; border: 2px solid rgba(0, 198, 255, 0.3);">
                        `;
                    };
                    reader.readAsDataURL(file);
                    
                    // التحقق من حجم الصورة
                    const maxSize = 10 * 1024 * 1024;
                    if (file.size > maxSize) {
                        showNotification("تحذير", "حجم الصورة كبير جداً (الحد الأقصى 10MB)", "warning");
                        this.value = "";
                        fileName.textContent = "اختر صورة للمنتج (اختياري)";
                        document.getElementById("imagePreview").innerHTML = "";
                    }
                } else {
                    fileName.textContent = "اختر صورة للمنتج (اختياري)";
                    document.getElementById("imagePreview").innerHTML = "";
                }
            });
        }
        
        // تعيين حدث لملف التحويل
        const transferProof = document.getElementById("transferProof");
        const transferFileName = document.getElementById("transfer-file-name");
        
        if (transferProof && transferFileName) {
            transferProof.addEventListener("change", function() {
                if (this.files && this.files[0]) {
                    const file = this.files[0];
                    transferFileName.textContent = file.name;
                    
                    // عرض معاينة الصورة
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const preview = document.getElementById("transferProofPreview");
                        preview.innerHTML = `
                            <p style="color: #4cd964; margin-bottom: 10px;">
                                <i class="fas fa-image"></i> معاينة الصورة:
                            </p>
                            <img src="${e.target.result}" style="max-width: 200px; max-height: 150px; border-radius: 10px; border: 2px solid rgba(0, 198, 255, 0.3);">
                        `;
                    };
                    reader.readAsDataURL(file);
                } else {
                    transferFileName.textContent = "اختر صورة إثبات التحويل";
                    document.getElementById("transferProofPreview").innerHTML = "";
                }
            });
        }
        
        // تحميل البيانات من Firebase
        loadProducts();
        loadOrders();
        
        // تهيئة نظام الكاشير
        updateCashierStats();
        
        // تعيين طريقة الدفع الافتراضية
        selectPaymentMethod('cash');
        selectDeliveryMethod('pickup');
        
        // تعيين تواريخ افتراضية لتقرير المدفوعات
        const today = new Date().toISOString().split('T')[0];
        const startDateInput = document.getElementById("startDate");
        const endDateInput = document.getElementById("endDate");
        
        if (startDateInput) {
            startDateInput.value = today;
        }
        if (endDateInput) {
            endDateInput.value = today;
        }
        
        setTimeout(() => {
            showNotification("مرحباً", "تم تحميل لوحة التحكم بنجاح!", "info");
            console.log("✅ لوحة التحكم جاهزة للاستخدام");
        }, 1000);
    });
</script>

</body>
</html>
